<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† å®Ÿé¨“ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; --text-color: #333; --sub-blue: #EAF4FF; --adm-green: #00ff41; --adm-red: #ff3333; }
        .dark-mode { --bg-color: #050505; --text-color: var(--adm-green); --sub-blue: #111; }

        body { font-family: "Hiragino Maru Gothic Pro", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); transition: 0.5s; }
        .account-bar { background: var(--main-blue); color: #fff; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        section { margin-bottom: 25px; padding: 20px; border-radius: 20px; background: #fff; border: 2px solid var(--sub-blue); }
        .dark-mode section { background: #000; border-color: var(--adm-green); }

        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .profile-card { display: flex; align-items: center; gap: 15px; text-align: left; }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--main-blue); }
        .profile-info { flex: 1; }
        .profile-bio { font-size: 0.85em; color: #666; margin-top: 5px; cursor: pointer; }
        .dark-mode .profile-bio { color: var(--adm-green); }

        /* è£ä¸–ç•Œï¼šæ”¹ã–ã‚“å¸ä»¤å®¤ */
        #adm-console { display: none; background: #000; color: var(--adm-green); border: 3px solid var(--adm-green); border-radius: 20px; padding: 20px; margin-bottom: 30px; font-family: monospace; }
        .adm-box { border: 1px solid var(--adm-green); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left; }
        .adm-input { background: #000; border: 1px solid var(--adm-green); color: var(--adm-green); width: 100%; padding: 8px; margin-bottom: 5px; box-sizing: border-box; }
        .adm-btn { background: var(--adm-green); color: #000; border: none; padding: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 5px; }

        .editable-active { outline: 2px dashed var(--adm-green); cursor: pointer; }
        .chat-container { height: 250px; overflow-y: auto; background: #f8f9fa; border-radius: 15px; padding: 15px; display: flex; flex-direction: column; }
        .dark-mode .chat-container { background: #000; border: 1px solid var(--adm-green); }
        .chat-bubble { background: #fff; border-radius: 15px; padding: 10px; margin-bottom: 8px; color: #333; position: relative; width: fit-content; max-width: 80%; }
        .dark-mode .chat-bubble { background: #1a1a1a; color: var(--adm-green); border: 1px solid var(--adm-green); }
        
        .badge { font-size: 0.7em; padding: 2px 8px; border-radius: 4px; color: white; background: #666; font-weight: bold; }
        .badge-admin { background: #000; color: #ffd700 !important; border: 1px solid #ffd700; }
    </style>
</head>
<body>

<div class="account-bar">
    <div>ğŸ‘¤ <span id="my-badge-area"></span><span id="display-user">ã‚²ã‚¹ãƒˆ</span></div>
    <button onclick="logout()" style="background:none; border:1px solid #fff; color:#fff; cursor:pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

<div class="container">
    <header style="margin-bottom:20px;">
        <h1 id="site-title" class="editable-text" onclick="editStaticText('site-title')">æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†</h1>
        <div class="profile-card" style="background:rgba(255,255,255,0.5); padding:15px; border-radius:15px;">
            <img src="image_b322c7.png" class="profile-img">
            <div class="profile-info">
                <b id="hero-name" class="editable-text" onclick="editStaticText('hero-name')">æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†</b>
                <div id="hero-bio" class="profile-bio editable-text" onclick="editStaticText('hero-bio')">é–“é•ã„ã‚’æ¶ˆã—å»ã‚‹å­¤é«˜ã®æˆ¦å£«ã€‚</div>
            </div>
        </div>
    </header>

    <section id="adm-console">
        <h2 style="color:white; border-bottom:1px solid var(--adm-green);">DATA OVERRIDE</h2>
        <div class="adm-box">
            <b>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ”¹ã–ã‚“</b><br><br>
            å¯¾è±¡: <select id="adm-user-select" class="adm-input"></select>
            ç§°å·: <input type="text" id="adm-title-input" class="adm-input" placeholder="æ–°ç§°å·">
            ç´¹ä»‹æ–‡: <input type="text" id="adm-bio-input" class="adm-input" placeholder="ç´¹ä»‹æ–‡ã‚’å¼·åˆ¶ä¸Šæ›¸ã">
            <button class="adm-btn" onclick="admFullUpdate()">ä¸€æ‹¬æ”¹ã–ã‚“å®Ÿè¡Œ</button>
        </div>
        <button class="adm-btn" style="background:orange;" onclick="showUserPassList()">ğŸ”‘ å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º</button>
    </section>

    <section>
        <h4>My Profile</h4>
        <div class="profile-bio" id="my-bio-display" onclick="updateMyBio()">è‡ªå·±ç´¹ä»‹ã‚’è¨­å®šï¼ˆã“ã“ã‚’ã‚¿ãƒƒãƒ—ï¼‰</div>
    </section>

    <section>
        <h4 id="rank-head" class="editable-text" onclick="editStaticText('rank-head')">ğŸ† ä¸–ç•Œãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
        <div id="ranking-display"></div>
    </section>

    <section>
        <h4>ğŸ’¬ é€šä¿¡ãƒ­ã‚°</h4>
        <div class="chat-container" id="chat-display"></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="chat-msg" style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd;">
            <button onclick="sendChat()" style="padding:10px 20px; background:var(--main-blue); color:white; border:none; border-radius:10px;">é€ä¿¡</button>
        </div>
    </section>
</div>

<div onclick="toggleBackworld()" style="position:fixed; bottom:0; right:0; width:40px; height:40px; opacity:0; z-index:10000;"></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw", authDomain: "keshigomuuu-f5183.firebaseapp.com", projectId: "keshigomuuu-f5183", storageBucket: "keshigomuuu-f5183.firebasestorage.app", messagingSenderId: "541731028448", appId: "1:541731028448:web:512938a4ca14e61842bf85" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let myID = localStorage.getItem("ntaro_id") || "ID_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("ntaro_id", myID);
    let myName = localStorage.getItem("ntaro_user") || "";
    let userData = { title: 'æ–°äºº', bio: 'ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚', uid: myID };
    let isBackworld = false;

    window.onload = () => { if(!myName) login(); else init(); };

    async function login() {
        let n = prompt("åå‰"); if(!n) return;
        const r = db.collection("users").doc(n), d = await r.get();
        if(d.exists) { if(prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")===d.data().pass) { myName=n; init(); } else login(); }
        else { let p = prompt("æ–°è¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"); await r.set({pass:p, title:'æ–°äºº', bio:'ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚', uid:myID}); myName=n; init(); }
        localStorage.setItem("ntaro_user", myName);
    }

    async function init() {
        db.collection("users").doc(myName).onSnapshot(doc => {
            if(!doc.exists) return;
            userData = doc.data();
            document.getElementById("display-user").innerText = myName;
            document.getElementById("my-badge-area").innerHTML = `<span class="badge ${userData.title==='ç®¡ç†äºº'?'badge-admin':''}">${userData.title}</span>`;
            document.getElementById("my-bio-display").innerText = userData.bio || "è‡ªå·±ç´¹ä»‹æœªè¨­å®š";
        });

        db.collection("users").onSnapshot(s => {
            document.getElementById("adm-user-select").innerHTML = s.docs.map(d => `<option value="${d.id}">${d.id}</option>`).join('');
        });

        startLoadingData();
        syncStaticTexts();
    }

    async function updateMyBio() {
        const newBio = prompt("è‡ªå·±ç´¹ä»‹ã‚’ç·¨é›†:", userData.bio);
        if(newBio) await db.collection("users").doc(myName).update({bio: newBio});
    }

    // --- ç®¡ç†è€…ï¼šä¸€æ‹¬æ”¹ã–ã‚“ ---
    async function admFullUpdate() {
        const target = document.getElementById("adm-user-select").value;
        const newTitle = document.getElementById("adm-title-input").value;
        const newBio = document.getElementById("adm-bio-input").value;
        let updateData = {};
        if(newTitle) updateData.title = newTitle;
        if(newBio) updateData.bio = newBio;
        await db.collection("users").doc(target).update(updateData);
        alert(target + " ã‚’æ”¹ã–ã‚“ã—ã¾ã—ãŸ");
    }

    function toggleBackworld() {
        if(!isBackworld && (userData.title==='ç®¡ç†äºº' || prompt("KEY")==='keshi99')) {
            isBackworld = true;
            document.body.classList.add('dark-mode');
            document.getElementById('adm-console').style.display = 'block';
            document.querySelectorAll('.editable-text').forEach(el => el.classList.add('editable-active'));
        } else if(isBackworld) { location.reload(); }
    }

    async function editStaticText(id) {
        if(!isBackworld) return;
        const newText = prompt("ãƒ†ã‚­ã‚¹ãƒˆæ”¹ã–ã‚“:", document.getElementById(id).innerText);
        if(newText) await db.collection("configs").doc(id).set({text: newText});
    }

    function syncStaticTexts() {
        db.collection("configs").onSnapshot(s => s.forEach(d => { if(document.getElementById(d.id)) document.getElementById(d.id).innerText = d.data().text; }));
    }

    function startLoadingData() {
        db.collection("rank_classic").orderBy("score", "desc").limit(10).onSnapshot(s => {
            document.getElementById('ranking-display').innerHTML = s.docs.map((doc, i) => {
                const d = doc.data();
                const scoreEv = isBackworld ? `onclick="tamperScore('${doc.id}', ${d.score})"` : "";
                return `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                    <span>${i+1}ä½: ${d.name}</span>
                    <b ${scoreEv} style="cursor:pointer;">${d.score}</b>
                </div>`;
            }).join('');
        });
        db.collection("chats").orderBy("date", "asc").limitToLast(10).onSnapshot(s => {
            document.getElementById('chat-display').innerHTML = s.docs.map(doc => `<div class="chat-bubble"><b>${doc.data().name}</b>: ${doc.data().msg}</div>`).join('');
            document.getElementById('chat-display').scrollTop = 999;
        });
    }

    async function tamperScore(id, old) {
        if(!isBackworld) return;
        const n = prompt("ã‚¹ã‚³ã‚¢æ”¹ã–ã‚“:", old);
        if(n) await db.collection("rank_classic").doc(id).update({score: Number(n)});
    }

    async function sendChat() {
        const m = document.getElementById('chat-msg').value;
        if(m) { await db.collection("chats").add({name:myName, msg:m, date:new Date()}); document.getElementById('chat-msg').value=""; }
    }
    async function showUserPassList() {
        const s = await db.collection("users").get();
        alert(s.docs.map(d => `${d.id}: ${d.data().pass}`).join("\n"));
    }
    function logout() { localStorage.removeItem("ntaro_user"); location.reload(); }
</script>
</body>
</html>
