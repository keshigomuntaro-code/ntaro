<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† å®Œå…¨ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; --text-color: #333; --adm-green: #00ff41; --adm-red: #ff4444; --fever-gold: #FFD700; }
        .dark-mode { --bg-color: #050505; --text-color: var(--adm-green); }
        body { font-family: "Hiragino Maru Gothic Pro", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); transition: 0.5s; text-align: center; overflow-x: hidden; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
        .account-bar { background: var(--main-blue); color: #fff; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .hero-section { background: #fff; margin: 10px; padding: 15px; border-radius: 20px; display: flex; align-items: center; gap: 15px; text-align: left; border: 1px solid #ddd; }
        .dark-mode .hero-section { background: #111; border-color: var(--adm-green); }
        .hero-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--main-blue); }

        .container { max-width: 600px; margin: 0 auto; padding: 0 10px; }
        section { margin-bottom: 20px; padding: 15px; border-radius: 20px; background: #fff; border: 1px solid #ddd; }
        .dark-mode section { background: #000; border-color: var(--adm-green); }

        /* ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚²ãƒ¼ã‚¸ */
        #fever-container { width: 100%; height: 12px; background: #eee; border-radius: 6px; margin-bottom: 10px; overflow: hidden; border: 1px solid #ccc; }
        #fever-bar { width: 0%; height: 100%; background: var(--fever-gold); transition: 0.1s; }
        .fever-active #fever-bar { background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00); animation: rainbow 0.5s infinite; }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-container { position: relative; width: 100%; height: 350px; background-color: #fff; border-radius: 15px; overflow: hidden; touch-action: none; border: 2px solid #ddd; }
        .dark-mode #game-container { background: #000; border-color: var(--adm-green); }
        #player { position: absolute; bottom: 15px; width: 55px; z-index: 10; pointer-events: none; transform: translateX(-50%); }
        .falling { position: absolute; font-size: 30px; z-index: 5; pointer-events: none; }

        /* è£ä¸–ç•Œï¼šå¸ä»¤å®¤ */
        #adm-console { display: none; background: #000; color: var(--adm-green); border: 2px solid var(--adm-green); padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: left; font-family: monospace; }
        .adm-btn { background: var(--adm-green); color: #000; border: none; padding: 6px; cursor: pointer; width: 100%; margin-top: 5px; font-weight: bold; border-radius: 5px; }

        .log-area { text-align: left; height: 140px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 10px; font-size: 0.85em; border: 1px solid #eee; }
        .dark-mode .log-area { background: #111; border-color: var(--adm-green); }
    </style>
</head>
<body>

<div class="account-bar">
    <div>ğŸ‘¤ <span id="my-badge-area"></span><span id="display-user">ã‚²ã‚¹ãƒˆ</span></div>
    <button onclick="logout()" style="background:none; border:1px solid #fff; color:#fff; border-radius:5px; font-size:12px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

<div class="hero-section">
    <img src="image_b322c7.png" class="hero-img">
    <div>
        <b id="hero-name">æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†</b><br>
        <span id="hero-bio" style="font-size:0.8em; color:#666;">é–“é•ã„ã‚’æ¶ˆã—å»ã‚‹å­¤é«˜ã®æˆ¦å£«ã€‚</span>
    </div>
</div>

<div class="container">
    <section id="adm-console">
        <div style="border-bottom:1px solid var(--adm-green);">OVERRIDE TERMINAL</div>
        <div style="margin-top:10px; font-size:12px;">
            å¯¾è±¡: <select id="adm-user-select" style="background:#000; color:var(--adm-green);"></select>
            <input type="text" id="adm-title-input" placeholder="ç¥" style="width:60px;">
            <button class="adm-btn" onclick="admApplyTitle()">ç§°å·æ”¹ã–ã‚“å®Ÿè¡Œ</button>
            <button class="adm-btn" style="background:var(--fever-gold)" onclick="forceFever()">å¼·åˆ¶ãƒ•ã‚£ãƒ¼ãƒãƒ¼ç™ºå‹•</button>
            <button class="adm-btn" style="background:var(--adm-red); color:white;" onclick="toggleInvincible()">ç„¡æ•µãƒ¢ãƒ¼ãƒ‰: <span id="inv-status">OFF</span></button>
        </div>
    </section>

    <section id="game-section">
        <div id="fever-container"><div id="fever-bar"></div></div>
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:14px; margin-bottom:5px;">
            <span id="score-board">Score: 0</span>
            <span id="timer">30s</span>
        </div>
        <div id="game-container">
            <img src="image_b322c7.png" id="player">
            <div id="start-screen" style="position:absolute; inset:0; background:rgba(74,144,226,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; color:white;">
                <h2 style="margin:0;">æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†</h2>
                <p style="font-size:12px;">â˜ï¸(+10) / ğŸŒŸ(é«˜å¾—ç‚¹) / ğŸ’£(æ¸›ç‚¹)</p>
                <button onclick="startGame()" style="padding:12px 35px; border-radius:50px; border:none; background:#fff; font-weight:bold; color:var(--main-blue); cursor:pointer;">START</button>
            </div>
        </div>
    </section>

    <section>
        <h4 style="margin:0 0 10px 0;">ğŸ† ä¸–ç•Œãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
        <div id="ranking-display" class="log-area"></div>
    </section>

    <section>
        <h4 style="margin:0 0 5px 0;">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h4>
        <div id="chat-display" class="log-area"></div>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <input type="text" id="chat-msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" style="flex:1; padding:8px; border-radius:5px; border:1px solid #ddd;">
            <button onclick="sendChat()" style="padding:8px; background:var(--main-blue); color:white; border:none; border-radius:5px;">é€ä¿¡</button>
        </div>
    </section>
</div>

<div onclick="toggleBackworld()" style="position:fixed; bottom:0; right:0; width:40px; height:40px; opacity:0; z-index:10000;"></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw", authDomain: "keshigomuuu-f5183.firebaseapp.com", projectId: "keshigomuuu-f5183", storageBucket: "keshigomuuu-f5183.firebasestorage.app", messagingSenderId: "541731028448", appId: "1:541731028448:web:512938a4ca14e61842bf85" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let myID = localStorage.getItem("ntaro_id") || "ID_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("ntaro_id", myID);
    let myName = localStorage.getItem("ntaro_user") || "";
    let userData = { title: 'æ–°äºº' };
    let isPlaying = false, score = 0, isBackworld = false, fever = 0, isFeverMode = false, isInvincible = false;

    window.onload = () => { if(!myName) login(); else init(); };

    async function login() {
        let n = prompt("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›"); if(!n) return;
        const r = db.collection("users").doc(n), d = await r.get();
        if(d.exists) { if(prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")===d.data().pass) { myName=n; init(); } else login(); }
        else { let p = prompt("æ–°è¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š"); await r.set({pass:p, title:'æ–°äºº', uid:myID}); myName=n; init(); }
        localStorage.setItem("ntaro_user", myName);
    }

    async function init() {
        db.collection("users").doc(myName).onSnapshot(doc => {
            if(!doc.exists) return;
            userData = doc.data();
            document.getElementById("display-user").innerText = myName;
            document.getElementById("my-badge-area").innerHTML = `<span style="font-size:10px; padding:2px 5px; background:#666; color:white; border-radius:3px; margin-right:5px; vertical-align:middle;">${userData.title}</span>`;
        });
        db.collection("users").onSnapshot(s => {
            document.getElementById("adm-user-select").innerHTML = s.docs.map(d => `<option value="${d.id}">${d.id}</option>`).join('');
        });
        syncData();
    }

    // --- ã‚²ãƒ¼ãƒ å‡¦ç† (å®Œå…¨ç‰ˆ) ---
    const player = document.getElementById("player");
    const container = document.getElementById("game-container");
    let px = 50;

    container.addEventListener("touchmove", e => { if(!isPlaying) return; px = (e.touches[0].clientX / window.innerWidth) * 100; updatePlayerPos(); });
    container.addEventListener("mousemove", e => { if(!isPlaying) return; px = (e.offsetX / container.offsetWidth) * 100; updatePlayerPos(); });
    function updatePlayerPos() { 
        if(px < 5) px = 5; if(px > 95) px = 95;
        player.style.left = px + "%"; 
    }

    function startGame() {
        isPlaying = true; score = 0; fever = 0; isFeverMode = false;
        document.getElementById("start-screen").style.display = "none";
        document.getElementById("fever-container").classList.remove("fever-active");
        updateUI();
        let timeLeft = 30;
        
        const timerInt = setInterval(() => {
            if(!isPlaying) { clearInterval(timerInt); return; }
            timeLeft--;
            document.getElementById("timer").innerText = timeLeft + "s";
            
            if(timeLeft <= 0) {
                isPlaying = false; clearInterval(timerInt);
                document.getElementById("start-screen").style.display = "flex";
                document.getElementById("start-screen").innerHTML = `<h2>FINISH!</h2><p>Score: ${score}</p><button onclick="location.reload()" style="padding:12px 35px; border-radius:50px; border:none; background:#fff; font-weight:bold; color:var(--main-blue); cursor:pointer;">RETRY</button>`;
                saveScore(score);
            }

            // ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆé »åº¦èª¿æ•´
            let spawnRate = isFeverMode ? 0.6 : 0.3;
            if(Math.random() < spawnRate) {
                let r = Math.random();
                if(r < 0.08) createItem("ğŸŒŸ"); // æ˜Ÿ
                else if(r < 0.25) createItem("ğŸ’£"); // çˆ†å¼¾
                else createItem("â˜ï¸"); // é›²
            }
        }, 100);
    }

    function createItem(type) {
        const item = document.createElement("div");
        item.className = "falling"; item.innerText = type;
        item.style.left = Math.random() * 90 + "%";
        item.style.top = "-40px";
        if(type === "ğŸŒŸ") item.style.filter = "drop-shadow(0 0 8px gold)";
        container.appendChild(item);

        let top = -40;
        const fallInt = setInterval(() => {
            if(!isPlaying) { clearInterval(fallInt); item.remove(); return; }
            top += isFeverMode ? 10 : 6;
            item.style.top = top + "px";
            
            const pRect = player.getBoundingClientRect();
            const iRect = item.getBoundingClientRect();

            if(iRect.top > pRect.top - 20 && iRect.left > pRect.left - 25 && iRect.left < pRect.right + 25) {
                if(type === "â˜ï¸") {
                    score += isFeverMode ? 50 : 10;
                    if(!isFeverMode) {
                        fever = Math.min(100, fever + 8);
                        if(fever >= 100) startFever();
                    }
                } else if(type === "ğŸŒŸ") {
                    score += 500; // æ˜Ÿã¯é«˜å¾—ç‚¹
                    fever = Math.min(100, fever + 20);
                } else {
                    if(!isInvincible) {
                        score = Math.max(0, score - 50);
                        fever = 0;
                        container.style.background = "#ffcccc";
                        setTimeout(() => container.style.background = isBackworld ? "#000" : "#fff", 150);
                    }
                }
                updateUI(); clearInterval(fallInt); item.remove();
            }
            if(top > 400) { clearInterval(fallInt); item.remove(); }
        }, 30);
    }

    function startFever() {
        isFeverMode = true;
        document.getElementById("fever-container").classList.add("fever-active");
        let fLimit = 100;
        const fInt = setInterval(() => {
            fLimit -= 1.5; fever = fLimit;
            updateUI();
            if(fLimit <= 0 || !isPlaying) {
                isFeverMode = false; fever = 0;
                document.getElementById("fever-container").classList.remove("fever-active");
                clearInterval(fInt);
            }
        }, 100);
    }

    function updateUI() {
        document.getElementById("score-board").innerText = "Score: " + score;
        document.getElementById("fever-bar").style.width = fever + "%";
    }

    // --- ç®¡ç†ãƒ»åŒæœŸæ©Ÿèƒ½ ---
    function toggleBackworld() {
        if(!isBackworld && (userData.title==='ç®¡ç†äºº' || prompt("ADMIN KEY")==='keshi99')) {
            isBackworld = true; document.body.classList.add('dark-mode');
            document.getElementById('adm-console').style.display = 'block';
        } else if(isBackworld) { location.reload(); }
    }
    function forceFever() { if(isPlaying) startFever(); }
    function toggleInvincible() {
        isInvincible = !isInvincible;
        document.getElementById("inv-status").innerText = isInvincible ? "ON" : "OFF";
        player.style.filter = isInvincible ? "drop-shadow(0 0 10px #00ff41)" : "none";
    }
    async function admApplyTitle() {
        const target = document.getElementById("adm-user-select").value;
        const title = document.getElementById("adm-title-input").value;
        await db.collection("users").doc(target).update({title: title});
        alert("åæ˜ å®Œäº†");
    }
    function syncData() {
        db.collection("rank_classic").orderBy("score", "desc").limit(10).onSnapshot(s => {
            document.getElementById('ranking-display').innerHTML = s.docs.map((doc, i) => `<div style="padding:3px 0; border-bottom:1px solid #eee;">${i+1}. ${doc.id}: ${doc.data().score}</div>`).join('');
        });
        db.collection("chats").orderBy("date", "asc").limitToLast(10).onSnapshot(s => {
            document.getElementById('chat-display').innerHTML = s.docs.map(doc => `<div><b>${doc.data().name}</b>: ${doc.data().msg}</div>`).join('');
            document.getElementById('chat-display').scrollTop = 999;
        });
    }
    async function saveScore(s) {
        const ref = db.collection("rank_classic").doc(myName);
        const d = await ref.get();
        if(!d.exists || s > d.data().score) await ref.set({score: s});
    }
    async function sendChat() {
        const m = document.getElementById('chat-msg').value;
        if(m) { await db.collection("chats").add({name:myName, msg:m, date:new Date()}); document.getElementById('chat-msg').value=""; }
    }
    function logout() { localStorage.removeItem("ntaro_user"); location.reload(); }
</script>
</body>
</html>
