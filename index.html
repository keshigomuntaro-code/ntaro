<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† å®Œå…¨ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; --text-color: #333; --sub-blue: #EAF4FF; --fever-gold: #FFD700; }
        .dark-mode { --main-blue: #333; --bg-color: #000; --text-color: #eee; --sub-blue: #1a1a1a; --fever-gold: #fff; }
        body { font-family: "Hiragino Maru Gothic Pro", "Yu Gothic", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); text-align: center; transition: background 0.5s; overflow-x: hidden; }
        header { background: linear-gradient(135deg, #fff, var(--sub-blue)); padding: 20px; border-bottom: 5px solid var(--main-blue); }
        .account-bar { background: var(--main-blue); color: #fff; padding: 8px; font-size: 0.9em; font-weight: bold; cursor: pointer; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        section { margin-bottom: 25px; padding: 20px; border-radius: 20px; background: #fff; border: 2px solid var(--sub-blue); }
        .dark-mode section { background: #000; border: 1px solid #444; }
        
        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-container { position: relative; width: 100%; height: 350px; background-color: var(--sub-blue); border-radius: 10px; overflow: hidden; touch-action: none; cursor: crosshair; }
        #player { position: absolute; bottom: 10px; width: 60px; z-index: 10; pointer-events: none; left: 50%; transform: translateX(-50%); transition: all 0.3s; }
        .kusu { position: absolute; font-size: 30px; z-index: 5; pointer-events: none; }
        
        /* ã‚¬ãƒãƒ£UI */
        .gacha-box { background: #fffbe6; border: 3px dashed #ffd700; padding: 15px; border-radius: 15px; margin-top: 10px; }
        #gacha-result { font-weight: bold; font-size: 1.2em; color: #e67e22; margin: 10px 0; min-height: 1.5em; }

        .btn { padding: 10px 20px; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; background: var(--main-blue); color: #fff; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-gacha { background: #f39c12; box-shadow: 0 4px #d35400; }
        .btn-gacha:active { box-shadow: 0 0; transform: translateY(4px); }

        .badge { font-size: 0.75em; padding: 2px 8px; border-radius: 4px; margin-right: 5px; color: white; font-weight: bold; display: inline-block; }
        .badge-admin { background: #000; color: #ffd700 !important; border: 1px solid #ffd700; }
        .badge-ssr { background: linear-gradient(45deg, #ff00ff, #ffcc00); animation: flash 1s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .chat-container { text-align: left; height: 200px; overflow-y: auto; padding: 15px; background: var(--sub-blue); border-radius: 15px; display: flex; flex-direction: column; }
        .chat-bubble { background: #fff; border-radius: 15px; padding: 10px 14px; margin-bottom: 10px; align-self: flex-start; max-width: 85%; }
        .logout-btn { background: #ff4444; color: white; border: none; padding: 2px 8px; border-radius: 5px; font-size: 0.7em; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>
    <div id="ban-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:white; z-index:100000; justify-content:center; align-items:center;">
        <h1>ğŸš« ACCESS DENIED</h1>
    </div>

    <div id="main-content">
        <div class="account-bar" onclick="changeMyName()">
            ğŸ‘¤ <span id="display-user">...</span> <span id="my-badge-area"></span>
            | æ‰€æŒ: <span id="my-kp">0</span> KP
            <button id="logout-area" class="logout-btn" style="display:none;" onclick="event.stopPropagation(); logout();">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        
        <div class="container">
            <header><h1><span id="site_title">æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†</span> <span id="version-title" onclick="toggleBackworld()">å…¬å¼</span></h1></header>

            <section class="gacha-box">
                <h4 style="margin:0;">ğŸ æ¶ˆã—ã‚´ãƒ ã‚¬ãƒãƒ£</h4>
                <p style="font-size:0.8em; color:#666;">1å› 300 KP ã§ç§°å·ã¨ã‚¹ã‚­ãƒ³ã‚’ã‚²ãƒƒãƒˆï¼</p>
                <div id="gacha-result">ä½•ãŒå‡ºã‚‹ã‹ãªï¼Ÿ</div>
                <button class="btn btn-gacha" onclick="rollGacha()">ã‚¬ãƒãƒ£ã‚’å›ã™ (300KP)</button>
            </section>

            <section id="game-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-weight:bold;">
                    <span id="score-board">ä»Šå›: 0</span><span id="timer">æ®‹ã‚Š: 45s</span>
                </div>
                <div id="game-container">
                    <img src="image_b322c7.png" id="player">
                    <div id="start-screen" style="position:absolute; width:100%; height:100%; background:rgba(74, 144, 226, 0.8); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100;">
                        <h2 style="color:white; margin-bottom:10px;">ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ç›®æŒ‡ã›ï¼</h2>
                        <button class="btn" onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                    </div>
                </div>
            </section>

            <section>
                <h4>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚° (Top 10)</h4>
                <div id="ranking-display"></div>
            </section>

            <section>
                <h4>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h4>
                <div class="chat-container" id="chat-display"></div>
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <input type="text" id="chat-msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="padding:12px; border-radius:10px; border:1px solid #ddd; flex:1;">
                    <button class="btn" onclick="sendChat()">é€ä¿¡</button>
                </div>
            </section>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw", authDomain: "keshigomuuu-f5183.firebaseapp.com", projectId: "keshigomuuu-f5183", storageBucket: "keshigomuuu-f5183.firebasestorage.app", messagingSenderId: "541731028448", appId: "1:541731028448:web:512938a4ca14e61842bf85" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const ADMIN_PASS = "keshi99";

        let myID = localStorage.getItem("ntaro_id") || "ID_" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("ntaro_id", myID);
        let myName = localStorage.getItem("ntaro_user") || "";
        let myTitle = "";
        let myKP = 0;
        let isBackworld = false;

        const GACHA_LIST = [
            { n: "æ™®é€šã®æ¶ˆã—ã‚´ãƒ ", r: "C", s: 1.0, f: "none" },
            { n: "æ¿€è½ã¡è·äºº", r: "R", s: 1.1, f: "contrast(1.5)" },
            { n: "é»’æ¶ˆã—ã‚´ãƒ ãƒã‚¹ã‚¿ãƒ¼", r: "SR", s: 1.2, f: "invert(1)" },
            { n: "é»„é‡‘ã®æ¶ˆã—ã‚´ãƒ ã‚“", r: "SSR", s: 1.5, f: "sepia(1) saturate(5) hue-rotate(10deg)" },
            { n: "ä¼èª¬ã®é€æ˜æ¶ˆã—ã‚´ãƒ ", r: "SSR", s: 0.8, f: "opacity(0.5)" }
        ];

        window.onload = () => { initAccount(); startLoadingData(); };

        async function initAccount() {
            const b = await db.collection("bans").doc(myID).get(); 
            if(b.exists) { document.getElementById("main-content").style.display = "none"; document.getElementById("ban-screen").style.display = "flex"; return; }
            if (myName) {
                db.collection("users").doc(myName).onSnapshot(doc => {
                    if(doc.exists) {
                        const data = doc.data();
                        myTitle = data.title || "åˆå¿ƒè€…";
                        myKP = data.kp || 0;
                        document.getElementById("display-user").innerText = myName;
                        document.getElementById("my-badge-area").innerHTML = getBadgeHTML(myTitle);
                        document.getElementById("my-kp").innerText = myKP;
                        applySkin(myTitle);
                    } else { loginFlow(); }
                });
            } else { loginFlow(); }
        }

        async function loginFlow() { 
            let n = prompt("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); if(!n) return; 
            const r = db.collection("users").doc(n); const d = await r.get(); 
            if(d.exists) { if(prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")===d.data().pass) myName=n; else return loginFlow(); } 
            else { let p=prompt("æ–°è¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ±ºã‚ã¦ãã ã•ã„"); if(p){ await r.set({pass:p, uid:myID, title:"åˆå¿ƒè€…", kp:0}); myName=n; } } 
            localStorage.setItem("ntaro_user", myName); location.reload(); 
        }

        function getBadgeHTML(t) { 
            if(!t) return "";
            let cls = "badge-custom";
            if(t === "ç®¡ç†äºº") cls = "badge-admin";
            if(t.includes("SSR") || t.includes("ä¼èª¬") || t.includes("é»„é‡‘")) cls = "badge-ssr";
            return `<span class="badge ${cls}">${t}</span>`;
        }

        function applySkin(title) {
            const player = document.getElementById('player');
            const item = GACHA_LIST.find(x => x.n === title);
            if(item) {
                player.style.filter = item.f;
                player.style.transform = `translateX(-50%) scale(${item.s})`;
            }
        }

        // --- ã‚¬ãƒãƒ£ãƒ­ã‚¸ãƒƒã‚¯ ---
        async function rollGacha() {
            if(myKP < 300) return alert("KPãŒè¶³ã‚Šã¾ã›ã‚“ï¼ã‚²ãƒ¼ãƒ ã§éŠã‚“ã§è²¯ã‚ã¦ã­ã€‚");
            if(!confirm("300KPã‚’ä½¿ã£ã¦ã‚¬ãƒãƒ£ã‚’å›ã—ã¾ã™ã‹ï¼Ÿ")) return;

            myKP -= 300;
            await db.collection("users").doc(myName).update({ kp: myKP });

            const resDiv = document.getElementById('gacha-result');
            resDiv.innerText = "ã‚·ãƒ£ã‚«ã‚·ãƒ£ã‚«...ğŸŒ€";
            
            setTimeout(async () => {
                const rnd = Math.random();
                let result;
                if(rnd < 0.05) result = GACHA_LIST[3]; // é»„é‡‘
                else if(rnd < 0.10) result = GACHA_LIST[4]; // é€æ˜
                else if(rnd < 0.30) result = GACHA_LIST[2]; // é»’
                else if(rnd < 0.60) result = GACHA_LIST[1]; // è·äºº
                else result = GACHA_LIST[0]; // æ™®é€š

                resDiv.innerHTML = `âœ¨ã€${result.r}ã€‘${result.n}âœ¨`;
                await db.collection("users").doc(myName).update({ title: result.n });
                alert(`${result.n} ã‚’ç²å¾—ï¼ç§°å·ã¨ã‚¹ã‚­ãƒ³ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚`);
            }, 1200);
        }

        // --- ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ ---
        let score = 0, gameActive = false, timeLeft = 45;
        function startGame() {
            if(!myName) return; score=0; timeLeft=45; gameActive=true;
            document.getElementById('start-screen').style.display='none';
            const timerInt = setInterval(() => {
                timeLeft--; document.getElementById('timer').innerText=`æ®‹ã‚Š: ${timeLeft}s`;
                if(timeLeft<=0 || !gameActive) { 
                    clearInterval(timerInt); gameActive=false; 
                    finishGame();
                }
            }, 1000);
            spawnLoop();
        }

        async function finishGame() {
            document.getElementById('start-screen').style.display='flex';
            // ã‚¹ã‚³ã‚¢ã‚’KPã¨ã—ã¦åŠ ç®—
            const gainKP = Math.floor(score / 2);
            myKP += gainKP;
            await db.collection("users").doc(myName).update({ kp: myKP });
            await db.collection("ranking").add({uid:myID, name:myName, score, title:myTitle, date: firebase.firestore.FieldValue.serverTimestamp()});
            alert(`ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ã‚¹ã‚³ã‚¢: ${score}\nç²å¾—å ±é…¬: ${gainKP} KP`);
        }

        function spawnLoop() { if(!gameActive) return; spawnItem(); setTimeout(spawnLoop, 500); }
        function spawnItem() {
            const it = document.createElement('div'); it.className='kusu'; const r = Math.random();
            it.innerText = (r < 0.15) ? 'ğŸ’£' : (r < 0.4 ? 'â­' : 'â˜ï¸');
            it.style.left = Math.random()*(document.getElementById('game-container').offsetWidth-40)+'px'; it.style.top = '-40px';
            document.getElementById('game-container').appendChild(it);
            let fallInt = setInterval(() => {
                if(!gameActive) { it.remove(); clearInterval(fallInt); return; }
                let t = parseInt(it.style.top); it.style.top = (t + 6) + 'px';
                const pR = document.getElementById('player').getBoundingClientRect(), iR = it.getBoundingClientRect();
                if (!(pR.top > iR.bottom || pR.bottom < iR.top || pR.left > iR.right || pR.right < iR.left)) {
                    if(it.innerText === 'ğŸ’£') score = Math.max(0, score - 50);
                    else score += (it.innerText==='â­'?30:10);
                    document.getElementById('score-board').innerText = "ä»Šå›: " + score;
                    it.remove(); clearInterval(fallInt);
                }
                if (t > 400) { it.remove(); clearInterval(fallInt); }
            }, 20);
        }

        // --- ãƒ‡ãƒ¼ã‚¿åŒæœŸ ---
        function startLoadingData() {
            db.collection("chats").orderBy("date", "asc").limitToLast(15).onSnapshot(s => {
                document.getElementById('chat-display').innerHTML = s.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="chat-bubble"><div style="font-size:0.7em;font-weight:bold;">${getBadgeHTML(d.title)}${d.name}</div><div>${d.msg}</div></div>`;
                }).join('');
                document.getElementById('chat-display').scrollTop = 9999;
            });
            db.collection("ranking").orderBy("score", "desc").limit(10).onSnapshot(s => { 
                document.getElementById('ranking-display').innerHTML = s.docs.map((doc, i) => {
                    const d = doc.data();
                    return `<div style="padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                        <span>${i+1}ä½:${getBadgeHTML(d.title)}${d.name}</span>
                        <span style="font-weight:bold;">${d.score}</span></div>`;
                }).join(''); 
            });
        }

        async function sendChat() { const m = document.getElementById('chat-msg').value; if(m && myName) { await db.collection("chats").add({uid:myID, name:myName, msg:m, title:myTitle, date: firebase.firestore.FieldValue.serverTimestamp()}); document.getElementById('chat-msg').value=""; } }
        function move(cx) { if(!gameActive) return; const rect = document.getElementById('game-container').getBoundingClientRect(); let x = cx - rect.left - (document.getElementById('player').offsetWidth/2); document.getElementById('player').style.left = x + 'px'; }
        document.getElementById('game-container').addEventListener('mousemove', (e)=>move(e.clientX));
        document.getElementById('game-container').addEventListener('touchmove', (e)=>{ e.preventDefault(); move(e.touches[0].clientX); }, {passive:false});
        function toggleBackworld() { if(prompt("key")===ADMIN_PASS) { isBackworld=true; document.body.classList.add('dark-mode'); document.getElementById('logout-area').style.display="inline"; } }
        function logout() { localStorage.removeItem("ntaro_user"); location.reload(); }
    </script>
</body>
</html>
