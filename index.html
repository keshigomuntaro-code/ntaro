<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† æ”¹ã–ã‚“æ¨©é™ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; --text-color: #333; --sub-blue: #EAF4FF; --fever-gold: #FFD700; --adm-green: #00ff41; --adm-red: #ff3333; }
        .dark-mode { --bg-color: #050505; --text-color: var(--adm-green); --sub-blue: #111; }

        body { font-family: "Hiragino Maru Gothic Pro", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); transition: 0.5s; overflow-x: hidden; }
        .account-bar { background: var(--main-blue); color: #fff; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        section { margin-bottom: 25px; padding: 20px; border-radius: 20px; background: #fff; border: 2px solid var(--sub-blue); }
        .dark-mode section { background: #000; border-color: var(--adm-green); box-shadow: 0 0 15px rgba(0,255,65,0.1); }

        /* è£ä¸–ç•Œï¼šæ”¹ã–ã‚“å¸ä»¤å®¤ */
        #adm-console { display: none; background: #000; color: var(--adm-green); border: 3px solid var(--adm-green); border-radius: 20px; padding: 20px; margin-bottom: 30px; font-family: 'Courier New', monospace; text-align: left; }
        .adm-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .adm-box { border: 1px solid var(--adm-green); padding: 15px; border-radius: 10px; }
        .adm-input { background: #000; border: 1px solid var(--adm-green); color: var(--adm-green); width: 100%; padding: 8px; margin-bottom: 10px; }
        .adm-btn { background: var(--adm-green); color: #000; border: none; padding: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 5px; }
        .adm-btn.danger { background: var(--adm-red); color: white; }

        /* æ”¹ã–ã‚“å¯èƒ½ãƒ†ã‚­ã‚¹ãƒˆã®è£…é£¾ */
        .editable-active { outline: 2px dashed var(--adm-green); cursor: pointer; }
        .editable-active:hover { background: rgba(0, 255, 65, 0.1); }

        /* ã‚²ãƒ¼ãƒ ãƒ»ãƒãƒ£ãƒƒãƒˆ */
        #game-container { position: relative; width: 100%; height: 350px; background-color: var(--sub-blue); border-radius: 15px; overflow: hidden; touch-action: none; border: 2px solid #ddd; }
        #player { position: absolute; bottom: 10px; width: 60px; z-index: 10; pointer-events: none; transform: translateX(-50%); }
        .chat-container { text-align: left; height: 300px; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 15px; display: flex; flex-direction: column; }
        .dark-mode .chat-container { background: #000; border: 1px solid var(--adm-green); }
        .chat-bubble { background: #fff; border-radius: 15px; padding: 10px; margin-bottom: 10px; max-width: 85%; color: #333; position: relative; }
        .dark-mode .chat-bubble { background: #1a1a1a; color: var(--adm-green); }
        
        .adm-del-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; border: none; cursor: pointer; display: none; }
        .badge { font-size: 0.7em; padding: 2px 8px; border-radius: 4px; color: white; margin-right: 5px; background: #666; font-weight: bold; }
        .badge-admin { background: #000; color: #ffd700 !important; border: 1px solid #ffd700; }
    </style>
</head>
<body>

<div id="ban-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:red; z-index:100000; justify-content:center; align-items:center;"><h1>ğŸš« ACCESS DENIED</h1></div>

<div class="account-bar">
    <div>ğŸ‘¤ <span id="my-badge-area"></span><span id="display-user">ã‚²ã‚¹ãƒˆ</span></div>
    <button onclick="logout()" style="background:none; border:1px solid #fff; color:#fff; padding:4px; cursor:pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

<div class="container">
    <h1 id="site-title" class="editable-text" onclick="editStaticText('site-title')">æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†</h1>

    <section id="adm-console">
        <h2 style="color:white; border-bottom: 2px solid var(--adm-green);">OVERRIDE COMMAND</h2>
        <div class="adm-grid">
            <div class="adm-box">
                <b>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ”¹ã–ã‚“</b><br><br>
                å¯¾è±¡: <select id="adm-user-select" class="adm-input"></select>
                æ–°ç§°å·: <input type="text" id="adm-title-input" class="adm-input" placeholder="ç¥ / é‹å–¶ / å›šäºº">
                <button class="adm-btn" onclick="admApplyTitle()">ç§°å·ã‚’å¼·åˆ¶æ›¸ãæ›ãˆ</button>
                <button class="adm-btn danger" onclick="admBanUser()">æ°¸ä¹…è¿½æ”¾(BAN)</button>
            </div>
            <div class="adm-box">
                <b>ğŸ›  ã‚·ã‚¹ãƒ†ãƒ ä»‹å…¥</b><br><br>
                <button class="adm-btn" onclick="showUserPassList()">ğŸ”‘ å…¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é–²è¦§</button>
                <button class="adm-btn" onclick="showBanList()">ğŸš« BANãƒªã‚¹ãƒˆè§£é™¤</button>
                <button class="adm-btn danger" onclick="resetRank()">ğŸ—‘ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¨æ¶ˆå»</button>
                é€Ÿåº¦: <input type="range" id="adm-speed-range" min="2" max="25" onchange="admUpdateConfig()">
            </div>
        </div>
        <p style="font-size:10px; color:#666; margin-top:10px;">â€»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã‚¹ã‚³ã‚¢ã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚’ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã§æ”¹ã–ã‚“å¯èƒ½ã§ã™ã€‚</p>
    </section>

    <section id="game-section">
        <div id="game-container">
            <img src="image_b322c7.png" id="player">
            <div id="start-screen" style="position:absolute; width:100%; height:100%; background:rgba(74, 144, 226, 0.8); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; gap:10px;">
                <button style="padding:15px 30px; border-radius:50px; border:none; background:#50c878; color:white; font-weight:bold;" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:10px;">
            <span id="score-board">ã‚¹ã‚³ã‚¢: 0</span><span id="timer">æº–å‚™å®Œäº†</span>
        </div>
    </section>

    <section>
        <h4 id="rank-head" class="editable-text" onclick="editStaticText('rank-head')">ğŸ† ä¸–ç•Œãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
        <div id="ranking-display"></div>
    </section>

    <section>
        <h4 id="chat-head" class="editable-text" onclick="editStaticText('chat-head')">ğŸ’¬ ãƒ­ã‚°ï¼ˆãƒãƒ£ãƒƒãƒˆï¼‰</h4>
        <div class="chat-container" id="chat-display"></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="chat-msg" style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd;">
            <button onclick="sendChat()" style="padding:10px 20px; background:var(--main-blue); color:white; border:none; border-radius:10px;">é€ä¿¡</button>
        </div>
    </section>
</div>

<div onclick="toggleBackworld()" style="position:fixed; bottom:0; right:0; width:40px; height:40px; opacity:0; z-index:10000;"></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw", authDomain: "keshigomuuu-f5183.firebaseapp.com", projectId: "keshigomuuu-f5183", storageBucket: "keshigomuuu-f5183.firebasestorage.app", messagingSenderId: "541731028448", appId: "1:541731028448:web:512938a4ca14e61842bf85" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let myID = localStorage.getItem("ntaro_id") || "ID_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("ntaro_id", myID);
    let myName = localStorage.getItem("ntaro_user") || "";
    let userData = { title: 'æ–°äºº', uid: myID };
    let isBackworld = false, sysConfig = { speed: 6 };

    window.onload = () => { if(!myName) login(); else init(); };

    async function login() {
        let n = prompt("åå‰"); if(!n) return;
        const r = db.collection("users").doc(n), d = await r.get();
        if(d.exists) { if(prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")===d.data().pass) { myName=n; init(); } else login(); }
        else { let p = prompt("æ–°è¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"); await r.set({pass:p, title:'æ–°äºº', uid:myID}); myName=n; init(); }
        localStorage.setItem("ntaro_user", myName);
    }

    async function init() {
        const b = await db.collection("bans").doc(myID).get();
        if(b.exists) { document.body.innerHTML = "<h1>BAN</h1>"; return; }

        db.collection("users").doc(myName).onSnapshot(doc => {
            if(!doc.exists) return;
            userData = doc.data();
            document.getElementById("display-user").innerText = myName;
            document.getElementById("my-badge-area").innerHTML = `<span class="badge ${userData.title==='ç®¡ç†äºº'?'badge-admin':''}">${userData.title}</span>`;
            document.getElementById("player").style.width = (userData.title==='ç®¡ç†äºº') ? "150px" : "60px";
        });

        db.collection("users").onSnapshot(s => {
            document.getElementById("adm-user-select").innerHTML = s.docs.map(d => `<option value="${d.id}">${d.id}</option>`).join('');
        });

        startLoadingData();
        syncStaticTexts();
    }

    function startLoadingData() {
        db.collection("rank_classic").orderBy("score", "desc").limit(10).onSnapshot(s => {
            document.getElementById('ranking-display').innerHTML = s.docs.map((doc, i) => {
                const d = doc.data();
                // ã‚¹ã‚³ã‚¢æ”¹ã–ã‚“ã‚¤ãƒ™ãƒ³ãƒˆ
                const scoreEv = isBackworld ? `onclick="tamperScore('${doc.id}', ${d.score})"` : "";
                return `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
                    <span>${i+1}ä½: ${d.name}</span>
                    <b ${scoreEv} style="cursor:pointer;">${d.score}</b>
                </div>`;
            }).join('');
        });

        db.collection("chats").orderBy("date", "asc").limitToLast(15).onSnapshot(s => {
            document.getElementById('chat-display').innerHTML = s.docs.map(doc => {
                const d = doc.data();
                const delBtn = isBackworld ? `<button class="adm-del-btn" style="display:block" onclick="deleteChat('${doc.id}')">Ã—</button>` : "";
                return `<div class="chat-bubble"><b>${d.name}</b>: ${d.msg}${delBtn}</div>`;
            }).join('');
            document.getElementById('chat-display').scrollTop = 999;
        });
    }

    // --- æ”¹ã–ã‚“ãƒ»ç®¡ç†ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    function toggleBackworld() {
        if(!isBackworld && (userData.title==='ç®¡ç†äºº' || prompt("ADMIN KEY")==='keshi99')) {
            isBackworld = true;
            document.body.classList.add('dark-mode');
            document.getElementById('adm-console').style.display = 'block';
            document.querySelectorAll('.editable-text').forEach(el => el.classList.add('editable-active'));
            startLoadingData(); // ãƒœã‚¿ãƒ³å†æç”»ç”¨
        } else if(isBackworld) {
            location.reload();
        }
    }

    async function tamperScore(docId, oldScore) {
        if(!isBackworld) return;
        const newScore = prompt("æ–°ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›:", oldScore);
        if(newScore !== null) await db.collection("rank_classic").doc(docId).update({score: Number(newScore)});
    }

    async function deleteChat(id) { if(confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) await db.collection("chats").doc(id).delete(); }

    async function editStaticText(id) {
        if(!isBackworld) return;
        const newText = prompt("è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆæ”¹ã–ã‚“:", document.getElementById(id).innerText);
        if(newText) await db.collection("configs").doc(id).set({text: newText});
    }

    async function admApplyTitle() {
        const target = document.getElementById('adm-user-select').value;
        const title = document.getElementById('adm-title-input').value;
        await db.collection("users").doc(target).update({title: title});
        alert("æ”¹ã–ã‚“å®Œäº†");
    }

    async function admBanUser() {
        const target = document.getElementById('adm-user-select').value;
        const u = await db.collection("users").doc(target).get();
        await db.collection("bans").doc(u.data().uid).set({name: target});
        alert(target + " ã‚’å°å°ã—ã¾ã—ãŸ");
    }

    async function showUserPassList() {
        const s = await db.collection("users").get();
        alert(s.docs.map(d => `${d.id}: ${d.data().pass}`).join("\n"));
    }

    function syncStaticTexts() {
        db.collection("configs").onSnapshot(s => s.forEach(d => { if(document.getElementById(d.id)) document.getElementById(d.id).innerText = d.data().text; }));
    }

    // ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ãªã©ã¯ä»¥å‰ã®ã‚‚ã®ã‚’è¸è¥²
    function startGame() { /* ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç† */ document.getElementById('start-screen').style.display='none'; }
    async function sendChat() {
        const m = document.getElementById('chat-msg').value;
        if(m) { await db.collection("chats").add({name:myName, msg:m, date:new Date()}); document.getElementById('chat-msg').value=""; }
    }
    function logout() { localStorage.removeItem("ntaro_user"); location.reload(); }
</script>
</body>
</html>
