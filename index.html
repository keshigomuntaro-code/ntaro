<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ê∂à„Åó„Ç¥„É†„Çì„Åü„Çç„ÅÜ ÂÖ¨Âºè„Çµ„Ç§„Éà</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; --text-color: #333; --accent-pink: #FF6B6B; --sub-blue: #EAF4FF; --fever-gold: #FFD700; }
        body { font-family: "Hiragino Maru Gothic Pro", "Yu Gothic", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; text-align: center; }
        header { background: linear-gradient(135deg, #fff, var(--sub-blue)); padding: 20px; border-bottom: 5px solid var(--main-blue); }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; background: #fff; }
        
        section { margin-bottom: 25px; padding: 20px; border-radius: 20px; background: #fff; border: 2px solid var(--sub-blue); }

        /* „Éó„É≠„Éï„Ç£„Éº„É´ */
        .hero { background-color: var(--sub-blue); border: none; }
        .char-img { max-width: 140px; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.1)); cursor: pointer; transition: 0.2s; }
        .char-img:active { transform: scale(1.1); }
        .profile-text { text-align: left; background: #fff; padding: 12px; border-radius: 10px; font-size: 0.85em; margin-top: 10px; border-left: 5px solid var(--main-blue); }

        /* „Ç≤„Éº„É†„Ç®„É™„Ç¢ */
        #game-section { background: var(--main-blue); color: #fff; border: none; position: relative; overflow: hidden; }
        #game-container { position: relative; width: 100%; height: 400px; background-color: var(--sub-blue); border: 4px solid #fff; border-radius: 10px; overflow: hidden; touch-action: none; cursor: none; }
        #player { position: absolute; bottom: 10px; width: 60px; z-index: 10; pointer-events: none; transition: width 0.3s, filter 0.3s; }
        .kusu { position: absolute; font-size: 28px; z-index: 5; }
        
        /* „Ç≤„Éº„Ç∏ */
        .gauge-container { width: 100%; height: 15px; background: rgba(255,255,255,0.3); border-radius: 10px; margin: 10px 0; overflow: hidden; border: 2px solid #fff; }
        #fever-bar { width: 0%; height: 100%; background: var(--fever-gold); transition: width 0.2s; }

        /* „É™„Çπ„ÉàË°®Á§∫Ôºà„É≠„Ç∞„Éª„É©„É≥„Ç≠„É≥„Ç∞Ôºâ */
        .list-box { text-align: left; background: #fff; border-radius: 10px; padding: 10px; min-height: 50px; }
        .list-item { padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 0.85em; display: flex; justify-content: space-between; }

        /* „ÉÅ„É£„ÉÉ„Éà */
        #chat-section { border: 2px solid var(--main-blue); }
        .chat-container { text-align: left; height: 300px; overflow-y: auto; padding: 15px; background: var(--sub-blue); border-radius: 15px; margin-bottom: 10px; display: flex; flex-direction: column; }
        .chat-bubble { background: #fff; border-radius: 15px; padding: 8px 12px; margin-bottom: 8px; border: 1px solid #ddd; align-self: flex-start; max-width: 85%; word-break: break-all; font-size: 0.9em; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        .chat-name { font-size: 0.7em; color: var(--main-blue); font-weight: bold; }
        .chat-input-area { display: flex; gap: 5px; }
        .chat-input-area input { padding: 10px; border-radius: 10px; border: 1px solid #ddd; flex: 1; }

        .btn { padding: 10px 20px; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; background: var(--main-blue); color: #fff; }
        .modal { display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #fff; margin: 20% auto; padding: 30px; width: 80%; border-radius: 20px; }
        .fever-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3em; font-weight: bold; color: #ffeb3b; text-shadow: 2px 2px 0 #f57f17; z-index: 100; display: none; }
        .fever-active #game-container { animation: fever-bg 0.5s infinite; }
        @keyframes fever-bg { 0%, 100% { background: #fff9c4; } 50% { background: #fff176; } }
    </style>
</head>
<body id="main-body">
    <header><h1>Ê∂à„Åó„Ç¥„É†„Çì„Åü„Çç„ÅÜ ÂÖ¨Âºè</h1></header>
    <div class="container">
        <section class="hero">
            <img src="image_b322c7.png" alt="„Çì„Åü„Çç„ÅÜ" class="char-img" id="hero-click">
            <div class="profile-text">
                <strong>Ê∂à„Åó„Ç¥„É†„Çì„Åü„Çç„ÅÜ</strong>ÔºöË∫´„ÇíÂâä„Çä„ÄÅÈñìÈÅï„ÅÑ„ÇíÊ∂à„ÅóÂéª„ÇãÂ≠§È´ò„ÅÆ„Éí„Éº„É≠„Éº„ÄÇ
            </div>
        </section>

        <section id="game-section">
            <div id="fever-msg" class="fever-text">FEVER!!</div>
            <div class="gauge-container"><div id="fever-bar"></div></div>
            <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px;">
                <span id="score-board">„Çπ„Ç≥„Ç¢: 0</span>
                <span id="timer">„ÅÇ„Å®: 45s</span>
            </div>
            <div id="game-container">
                <img src="image_b322c7.png" id="player">
                <div id="start-screen" style="position:absolute; width:100%; height:100%; background:rgba(74, 144, 226, 0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000;">
                    <button class="btn" style="background:#fff; color:var(--main-blue); font-size:1.5em;" onclick="startGame()">„Çπ„Çø„Éº„Éà</button>
                </div>
            </div>
        </section>

        <section style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: none; border: none; padding: 0;">
            <div style="background:#fff; border: 2px solid var(--sub-blue); padding: 15px; border-radius: 20px;">
                <h4 oncontextmenu="addLog();return false;" onclick="handleLongPress(addLog)" style="margin:0 0 10px 0; color:var(--main-blue); cursor:pointer;">üöÄ „É≠„Ç∞</h4>
                <div class="list-box" id="log-display">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
            <div style="background:#fff; border: 2px solid var(--sub-blue); padding: 15px; border-radius: 20px;">
                <h4 style="margin:0 0 10px 0; color:var(--main-blue);">üèÜ È†Ü‰Ωç</h4>
                <div class="list-box" id="ranking-display">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
        </section>

        <section id="chat-section">
            <h2 style="color:var(--main-blue); margin-top:0; font-size: 1.1em;">üí¨ „Åø„Çì„Å™„ÅÆÊé≤Á§∫Êùø</h2>
            <div class="chat-container" id="chat-display">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            <div class="chat-input-area">
                <input type="text" id="chat-name" placeholder="„Å™„Åæ„Åà" maxlength="8">
                <input type="text" id="chat-msg" placeholder="„Çì„Åü„Çç„ÅÜ„Å´‰∏ÄË®ÄÔºÅ" maxlength="50">
                <button class="btn" onclick="sendChat()">ÈÄÅ‰ø°</button>
            </div>
        </section>
    </div>

    <div id="scoreModal" class="modal"><div class="modal-content">
        <h2 style="color:var(--main-blue);">ÁµÇ‰∫ÜÔºÅ</h2><p>„Çπ„Ç≥„Ç¢: <span id="final-score">0</span></p>
        <input type="text" id="rankingName" placeholder="„É©„É≥„Ç≠„É≥„Ç∞Áî®„ÅÆ„Å™„Åæ„Åà" maxlength="5">
        <button class="btn" style="width:100%;" onclick="saveScoreToFirebase()">„É©„É≥„Ç≠„É≥„Ç∞ÁôªÈå≤</button>
    </div></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw",
            authDomain: "keshigomuuu-f5183.firebaseapp.com",
            projectId: "keshigomuuu-f5183",
            storageBucket: "keshigomuuu-f5183.firebasestorage.app",
            messagingSenderId: "541731028448",
            appId: "1:541731028448:web:512938a4ca14e61842bf85",
            measurementId: "G-8H0QH3TMZN"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const ADMIN_PASS = "keshi99";

        // --- „ÉÅ„É£„ÉÉ„Éà ---
        async function sendChat() {
            const name = document.getElementById('chat-name').value || "„Å™„Å™„Åó";
            const msg = document.getElementById('chat-msg').value;
            if(!msg) return;
            await db.collection("chats").add({ name, msg, date: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('chat-msg').value = "";
        }
        function loadChats() {
            db.collection("chats").orderBy("date", "asc").limitToLast(15).onSnapshot(snap => {
                document.getElementById('chat-display').innerHTML = snap.docs.map(doc => 
                    `<div class="chat-bubble" oncontextmenu="deleteDoc('chats','${doc.id}');return false;" onclick="handleLongPress(()=>deleteDoc('chats','${doc.id}'))">
                        <div class="chat-name">${doc.data().name}</div>${doc.data().msg}
                    </div>`).join('');
                document.getElementById('chat-display').scrollTop = 9999;
            });
        }

        // --- „É≠„Ç∞ & „É©„É≥„Ç≠„É≥„Ç∞ ---
        function loadLogs() {
            db.collection("logs").orderBy("date", "desc").limit(3).onSnapshot(snap => {
                document.getElementById('log-display').innerHTML = snap.docs.map(doc => 
                    `<div class="list-item" oncontextmenu="deleteDoc('logs','${doc.id}');return false;">„Éª${doc.data().text}</div>`).join('');
            });
        }
        function loadRanking() {
            db.collection("ranking").orderBy("score", "desc").orderBy("date", "desc").limit(5).onSnapshot(snap => {
                document.getElementById('ranking-display').innerHTML = snap.docs.map((doc, i) => 
                    `<div class="list-item" oncontextmenu="deleteDoc('ranking','${doc.id}');return false;">
                        <span>${i+1}‰Ωç:${doc.data().name}</span><span>${doc.data().score}</span>
                    </div>`).join('');
            });
        }

        // --- „Ç≤„Éº„É† ---
        const container = document.getElementById('game-container');
        const player = document.getElementById('player');
        const feverBar = document.getElementById('fever-bar');
        const mainBody = document.getElementById('main-body');
        const feverMsg = document.getElementById('fever-msg');
        let score = 0, gameActive = false, timeLeft = 45, feverValue = 0, isFever = false;

        document.getElementById('hero-click').addEventListener('click', () => { if(gameActive) addScore(5); });

        function startGame() {
            gameActive = true; score = 0; timeLeft = 45; feverValue = 0; isFever = false;
            document.getElementById('start-screen').style.display = 'none';
            updateUI();
            spawnItem();
            let timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = `„ÅÇ„Å®: ${timeLeft}s`;
                if(timeLeft <= 0) {
                    gameActive = false; clearInterval(timerInterval);
                    document.getElementById('final-score').innerText = score;
                    document.getElementById('scoreModal').style.display = 'block';
                    document.getElementById('start-screen').style.display = 'flex';
                    endFever();
                }
            }, 1000);
        }

        function addScore(p) {
            score += p;
            if(!isFever) {
                feverValue = Math.min(100, feverValue + (p / 2));
                if(feverValue >= 100) startFever();
            }
            updateUI();
        }
        function startFever() {
            isFever = true; feverMsg.style.display = 'block';
            mainBody.classList.add('fever-active');
            player.style.width = "120px";
            setTimeout(endFever, 7000);
        }
        function endFever() {
            isFever = false; feverValue = 0; feverMsg.style.display = 'none';
            mainBody.classList.remove('fever-active');
            player.style.width = "60px";
            updateUI();
        }
        function updateUI() {
            document.getElementById('score-board').innerText = `„Çπ„Ç≥„Ç¢: ${score}`;
            feverBar.style.width = feverValue + "%";
        }
        function spawnItem() {
            if(!gameActive) return;
            const item = document.createElement('div');
            item.className = 'kusu';
            const r = Math.random();
            if(r < 0.15 && !isFever) item.innerText = 'üí£';
            else if(r < 0.3) item.innerText = '‚≠ê';
            else item.innerText = '‚òÅÔ∏è';
            item.style.left = Math.random() * (container.offsetWidth - 30) + 'px';
            item.style.top = '-30px';
            container.appendChild(item);
            let fall = setInterval(() => {
                let top = parseInt(item.style.top);
                item.style.top = (top + (isFever?8:5)) + 'px';
                const pR = player.getBoundingClientRect(), iR = item.getBoundingClientRect();
                if (!(pR.top > iR.bottom || pR.bottom < iR.top || pR.left > iR.right || pR.right < iR.left)) {
                    if(item.innerText === 'üí£') score = Math.max(0, score - 50);
                    else addScore(item.innerText === '‚≠ê' ? 30 : 10);
                    item.remove(); clearInterval(fall);
                }
                if (top > container.offsetHeight) { item.remove(); clearInterval(fall); }
            }, 20);
            setTimeout(spawnItem, isFever ? 150 : 500);
        }

        // --- „Åù„ÅÆ‰ªñ ---
        async function saveScoreToFirebase() {
            const name = document.getElementById('rankingName').value || "„Å™„Å™„Åó";
            await db.collection("ranking").add({ name, score, date: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('scoreModal').style.display = 'none';
        }
        async function deleteDoc(col, id) { if(prompt("Pass?") === ADMIN_PASS) await db.collection(col).doc(id).delete(); }
        async function addLog() { if(prompt("Pass?") === ADMIN_PASS) { const t = prompt("Log?"); if(t) await db.collection("logs").add({text:t, date: firebase.firestore.FieldValue.serverTimestamp()}); } }
        let pressTimer; function handleLongPress(f){ pressTimer=setTimeout(f,800); } window.onmouseup=()=>clearTimeout(pressTimer);
        
        function movePlayer(clientX) {
            if(!gameActive) return;
            const rect = container.getBoundingClientRect();
            let x = clientX - rect.left - (player.offsetWidth / 2);
            if(x < 0) x = 0; if(x > rect.width - player.offsetWidth) x = rect.width - player.offsetWidth;
            player.style.left = x + 'px';
        }
        container.addEventListener('mousemove', (e) => movePlayer(e.clientX));
        container.addEventListener('touchmove', (e) => { e.preventDefault(); movePlayer(e.touches[0].clientX); }, {passive: false});

        loadChats(); loadLogs(); loadRanking();
    </script>
</body>
</html>
