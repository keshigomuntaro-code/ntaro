<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† çœŸãƒ»æ”¹ã–ã‚“çµ±æ‹¬ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; --text-color: #333; --sub-blue: #EAF4FF; --fever-gold: #FFD700; --adm-green: #00ff41; --adm-red: #ff3333; }
        .dark-mode { --bg-color: #050505; --text-color: var(--adm-green); --sub-blue: #111; }
        body { font-family: "Hiragino Maru Gothic Pro", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); transition: 0.5s; overflow-x: hidden; text-align: center; }
        
        .account-bar { background: var(--main-blue); color: #fff; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 1000; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        
        section { margin-bottom: 20px; padding: 15px; border-radius: 20px; background: #fff; border: 2px solid var(--sub-blue); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .dark-mode section { background: #000; border-color: var(--adm-green); box-shadow: 0 0 15px rgba(0,255,65,0.1); }

        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
        .profile-area { display: flex; align-items: center; gap: 15px; text-align: left; background: var(--sub-blue); padding: 10px; border-radius: 15px; margin-bottom: 10px; }
        .dark-mode .profile-area { background: #111; border: 1px solid var(--adm-green); }
        .p-img { width: 50px; height: 50px; border-radius: 50%; background: #fff; border: 2px solid var(--main-blue); }
        .p-info b { font-size: 0.9em; }
        .p-bio { font-size: 0.75em; color: #666; }
        .dark-mode .p-bio { color: var(--adm-green); }

        /* ã‚²ãƒ¼ãƒ  */
        #game-container { position: relative; width: 100%; height: 300px; background-color: #fff; border-radius: 15px; overflow: hidden; touch-action: none; border: 2px solid #ddd; }
        .dark-mode #game-container { background: #050505; border-color: var(--adm-green); }
        #player { position: absolute; bottom: 10px; width: 50px; z-index: 10; pointer-events: none; transform: translateX(-50%); transition: width 0.3s; }
        .falling { position: absolute; font-size: 30px; z-index: 5; pointer-events: none; }
        #fever-bar-container { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin-bottom: 5px; overflow: hidden; }
        #fever-bar { width: 0%; height: 100%; background: var(--fever-gold); transition: 0.2s; }
        .fever-active #fever-bar { background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00); animation: rainbow 0.5s infinite; }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° & ãƒãƒ£ãƒƒãƒˆ */
        .glass-box { background: rgba(255,255,255,0.6); border-radius: 15px; padding: 10px; text-align: left; max-height: 200px; overflow-y: auto; }
        .dark-mode .glass-box { background: rgba(0,0,0,0.8); border: 1px solid var(--adm-green); }
        .rank-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.9em; }
        .chat-bubble { padding: 5px 10px; margin-bottom: 5px; border-radius: 10px; background: #eee; font-size: 0.85em; width: fit-content; max-width: 90%; position: relative; }
        .dark-mode .chat-bubble { background: #1a1a1a; border: 1px solid var(--adm-green); }

        /* ç®¡ç†ãƒ‘ãƒãƒ« */
        #adm-console { display: none; background: #000; color: var(--adm-green); border: 3px solid var(--adm-green); border-radius: 20px; padding: 15px; margin-bottom: 20px; font-family: monospace; text-align: left; }
        .adm-btn { background: var(--adm-green); color: #000; border: none; padding: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; border-radius: 5px; }
        .editable-active { outline: 2px dashed var(--adm-green); cursor: pointer; }
        
        .badge { font-size: 0.7em; padding: 2px 6px; border-radius: 4px; color: white; background: #666; margin-right: 5px; }
        .badge-admin { background: #000; color: #ffd700 !important; border: 1px solid #ffd700; }
    </style>
</head>
<body>

<div class="account-bar">
    <div>ğŸ‘¤ <span id="my-badge-area"></span><span id="display-user">...</span></div>
    <button onclick="logout()" style="background:none; border:1px solid #fff; color:#fff; font-size:0.7em; padding:2px 8px; border-radius:5px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

<div class="container">
    <section>
        <div class="profile-area" onclick="editStaticText('hero-box')">
            <img src="image_b322c7.png" class="p-img">
            <div class="p-info">
                <b id="hero-name" class="editable-text">å…¬å¼ï¼šæ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†</b><br>
                <span id="hero-bio" class="p-bio editable-text">é–“é•ã„ã‚’æ¶ˆã—å»ã‚‹ç™½ãæ­£ç¾©ã€‚</span>
            </div>
        </div>
        <div class="profile-area" onclick="updateMyBio()">
            <div class="p-img" style="background:#eee; display:flex; align-items:center; justify-content:center;">ğŸ‘¤</div>
            <div class="p-info">
                <b>ãƒã‚¤ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</b> (ã‚¿ãƒƒãƒ—ã§ç·¨é›†)<br>
                <span id="my-bio-display" class="p-bio">ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚</span>
            </div>
        </div>
    </section>

    <section id="adm-console">
        <b style="border-bottom: 1px solid var(--adm-green);">MASTER OVERRIDE</b>
        <div style="margin-top:10px; font-size:0.8em;">
            å¯¾è±¡: <select id="adm-user-select" style="background:#000; color:var(--adm-green); border:1px solid var(--adm-green);"></select>
            <input type="text" id="adm-title-input" placeholder="æ–°ç§°å·" style="width:70px; background:#000; color:var(--adm-green); border:1px solid var(--adm-green);">
            <button class="adm-btn" onclick="admApplyTitle()">ç§°å·æ”¹ã–ã‚“</button>
            <button class="adm-btn" style="background:orange" onclick="showUserPassList()">ğŸ”‘ å…¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º</button>
        </div>
    </section>

    <section id="game-section">
        <div id="fever-bar-container"><div id="fever-bar"></div></div>
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:0.9em; margin-bottom:5px;">
            <span id="score-board">ã‚¹ã‚³ã‚¢: 0</span>
            <span id="timer">æº–å‚™å®Œäº†</span>
        </div>
        <div id="game-container">
            <img src="image_b322c7.png" id="player">
            <div id="start-screen" style="position:absolute; width:100%; height:100%; background:rgba(74, 144, 226, 0.8); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; color:white;">
                <p style="font-size:12px;margin-bottom:10px;">â˜ï¸(+10) / ğŸŒŸ(Bonus +500!) / ğŸ’£(-50)</p>
                <button onclick="startGame()" style="padding:10px 30px; border-radius:20px; border:none; background:#fff; font-weight:bold; cursor:pointer;">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            </div>
        </div>
    </section>

    <section>
        <h4 id="rank-head" class="editable-text" onclick="editStaticText('rank-head')" style="margin:0 0 10px 0;">ğŸ† ä¸–ç•Œãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
        <div id="ranking-display" class="glass-box"></div>
    </section>

    <section>
        <h4 style="margin:0 0 10px 0;">ğŸ’¬ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°</h4>
        <div id="chat-display" class="glass-box"></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="chat-msg" style="flex:1; padding:8px; border-radius:10px; border:1px solid #ddd;">
            <button onclick="sendChat()" style="padding:8px 15px; background:var(--main-blue); color:white; border:none; border-radius:10px;">é€ä¿¡</button>
        </div>
    </section>
</div>

<div onclick="toggleBackworld()" style="position:fixed; bottom:0; right:0; width:40px; height:40px; opacity:0; z-index:10000;"></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw", authDomain: "keshigomuuu-f5183.firebaseapp.com", projectId: "keshigomuuu-f5183", storageBucket: "keshigomuuu-f5183.firebasestorage.app", messagingSenderId: "541731028448", appId: "1:541731028448:web:512938a4ca14e61842bf85" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let myID = localStorage.getItem("ntaro_id") || "ID_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("ntaro_id", myID);
    let myName = localStorage.getItem("ntaro_user") || "";
    let userData = { title: 'æ–°äºº', bio: 'ã‚ˆã‚ã—ã', uid: myID };
    let isBackworld = false, score = 0, isPlaying = false, fever = 0, isFeverMode = false;

    window.onload = () => { if(!myName) login(); else init(); };

    async function login() {
        let n = prompt("åå‰"); if(!n) return;
        const r = db.collection("users").doc(n), d = await r.get();
        if(d.exists) { if(prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")===d.data().pass) { myName=n; init(); } else login(); }
        else { let p = prompt("æ–°è¦ãƒ‘ã‚¹ï¼šå¿˜ã‚Œãªã„ã§ã­"); await r.set({pass:p, title:'æ–°äºº', bio:'ã‚ˆã‚ã—ã', uid:myID}); myName=n; init(); }
        localStorage.setItem("ntaro_user", myName);
    }

    async function init() {
        db.collection("users").doc(myName).onSnapshot(doc => {
            if(!doc.exists) return;
            userData = doc.data();
            document.getElementById("display-user").innerText = myName;
            document.getElementById("my-badge-area").innerHTML = `<span class="badge ${userData.title==='ç®¡ç†äºº'?'badge-admin':''}">${userData.title}</span>`;
            document.getElementById("my-bio-display").innerText = userData.bio;
            document.getElementById("player").style.width = (userData.title==='ç®¡ç†äºº') ? "100px" : "50px";
        });
        db.collection("users").onSnapshot(s => {
            document.getElementById("adm-user-select").innerHTML = s.docs.map(d => `<option value="${d.id}">${d.id}</option>`).join('');
        });
        startSync();
    }

    // --- æ”¹å¤‰ã•ã‚ŒãŸã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
    const player = document.getElementById("player");
    const container = document.getElementById("game-container");
    let px = 50;

    container.addEventListener("touchmove", e => { if(!isPlaying) return; px = (e.touches[0].clientX / window.innerWidth) * 100; player.style.left = px + "%"; e.preventDefault(); }, {passive: false});
    container.addEventListener("mousemove", e => { if(!isPlaying) return; px = (e.offsetX / container.offsetWidth) * 100; player.style.left = px + "%"; });

    function startGame() {
        isPlaying = true; score = 0; fever = 0; isFeverMode = false;
        document.getElementById("start-screen").style.display = "none";
        document.getElementById("fever-bar-container").classList.remove("fever-active");
        updateUI();
        let timeLeft = 30;
        const mainLoop = setInterval(() => {
            if(!isPlaying) { clearInterval(mainLoop); return; }
            timeLeft--;
            document.getElementById("timer").innerText = "æ®‹ã‚Š: " + timeLeft + "ç§’";
            
            if(timeLeft <= 0) {
                isPlaying = false;
                document.getElementById("start-screen").style.display = "flex";
                document.getElementById("start-screen").innerHTML = `<h2>çµ‚äº†</h2><p>Score: ${score}</p><button onclick="location.reload()" style="padding:10px 20px; border-radius:20px; border:none; background:#fff; font-weight:bold; cursor:pointer;">ãƒªãƒˆãƒ©ã‚¤</button>`;
                saveScore(score);
                return;
            }

            // ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
            let rate = isFeverMode ? 0.6 : 0.3;
            if(Math.random() < rate) {
                let r = Math.random();
                if(r < 0.08) createItem("ğŸŒŸ");
                else if(r < 0.25) createItem("ğŸ’£");
                else createItem("â˜ï¸");
            }
        }, 100);
    }

    function createItem(type) {
        const item = document.createElement("div");
        item.className = "falling"; item.innerText = type;
        item.style.left = Math.random() * 90 + "%";
        item.style.top = "-40px";
        if(type === "ğŸŒŸ") item.style.filter = "drop-shadow(0 0 10px gold)";
        container.appendChild(item);

        let top = -40;
        const fall = setInterval(() => {
            if(!isPlaying) { item.remove(); clearInterval(fall); return; }
            top += isFeverMode ? 10 : 6;
            item.style.top = top + "px";
            const rectP = player.getBoundingClientRect();
            const rectI = item.getBoundingClientRect();

            if(rectI.bottom > rectP.top + 5 && rectI.top < rectP.bottom && rectI.left < rectP.right && rectI.right > rectP.left) {
                if(type === "â˜ï¸") {
                    score += isFeverMode ? 50 : 10;
                    if(!isFeverMode) { fever = Math.min(100, fever + 8); if(fever >= 100) startFever(); }
                } else if(type === "ğŸŒŸ") {
                    score += 500;
                    fever = Math.min(100, fever + 25);
                } else if(type === "ğŸ’£") {
                    score = Math.max(0, score - 50); fever = 0;
                    container.style.backgroundColor = "#ffcccc";
                    setTimeout(() => container.style.backgroundColor = isBackworld ? "#050505" : "#fff", 100);
                }
                updateUI(); clearInterval(fall); item.remove();
            }
            if(top > 300) { clearInterval(fall); item.remove(); }
        }, 30);
    }

    function startFever() {
        isFeverMode = true;
        document.getElementById("fever-bar-container").classList.add("fever-active");
        let fLimit = 100;
        const fInt = setInterval(() => {
            fLimit -= 2; fever = fLimit;
            updateUI();
            if(fLimit <= 0 || !isPlaying) {
                isFeverMode = false; fever = 0;
                document.getElementById("fever-bar-container").classList.remove("fever-active");
                clearInterval(fInt);
            }
        }, 150);
    }

    function updateUI() {
        document.getElementById("score-board").innerText = "ã‚¹ã‚³ã‚¢: " + score;
        document.getElementById("fever-bar").style.width = fever + "%";
    }

    async function saveScore(s) {
        const ref = db.collection("rank_classic").doc(myName);
        const d = await ref.get();
        if(!d.exists || s > d.data().score) await ref.set({name: myName, score: s});
    }

    // --- æ”¹ã–ã‚“ãƒ»é€šä¿¡ç³» ---
    function startSync() {
        db.collection("rank_classic").orderBy("score", "desc").limit(10).onSnapshot(s => {
            document.getElementById('ranking-display').innerHTML = s.docs.map((doc, i) => {
                const d = doc.data();
                const scoreEv = isBackworld ? `onclick="tamperScore('${doc.id}', ${d.score})"` : "";
                return `<div class="rank-item"><span>${i+1}. ${d.name}</span><b ${scoreEv}>${d.score}</b></div>`;
            }).join('');
        });
        db.collection("chats").orderBy("date", "asc").limitToLast(10).onSnapshot(s => {
            document.getElementById('chat-display').innerHTML = s.docs.map(doc => {
                const del = isBackworld ? `<span onclick="deleteChat('${doc.id}')" style="color:red;margin-left:5px">Ã—</span>` : "";
                return `<div class="chat-bubble"><b>${doc.data().name}</b>: ${doc.data().msg}${del}</div>`;
            }).join('');
            document.getElementById('chat-display').scrollTop = 999;
        });
        db.collection("configs").onSnapshot(s => s.forEach(d => { if(document.getElementById(d.id)) document.getElementById(d.id).innerText = d.data().text; }));
    }

    async function updateMyBio() {
        const b = prompt("è‡ªå·±ç´¹ä»‹ã‚’ç·¨é›†:", userData.bio);
        if(b) await db.collection("users").doc(myName).update({bio: b});
    }

    function toggleBackworld() {
        if(!isBackworld && (userData.title==='ç®¡ç†äºº' || prompt("KEY")==='keshi99')) {
            isBackworld = true; document.body.classList.add('dark-mode');
            document.getElementById('adm-console').style.display = 'block';
            document.querySelectorAll('.editable-text').forEach(el => el.classList.add('editable-active'));
        } else if(isBackworld) { location.reload(); }
    }

    async function editStaticText(id) {
        if(!isBackworld) return;
        const t = prompt("æ›¸ãæ›ãˆ:", document.getElementById(id).innerText);
        if(t) await db.collection("configs").doc(id).set({text: t});
    }

    async function tamperScore(id, old) {
        if(!isBackworld) return;
        const n = prompt("ã‚¹ã‚³ã‚¢æ”¹ã–ã‚“:", old);
        if(n) await db.collection("rank_classic").doc(id).update({score: Number(n)});
    }

    async function admApplyTitle() {
        const target = document.getElementById("adm-user-select").value;
        const title = document.getElementById("adm-title-input").value;
        await db.collection("users").doc(target).update({title: title});
        alert("æ›¸ãæ›ãˆã¾ã—ãŸ");
    }

    async function sendChat() {
        const m = document.getElementById('chat-msg').value;
        if(m) { await db.collection("chats").add({name:myName, msg:m, date:new Date()}); document.getElementById('chat-msg').value=""; }
    }
    async function deleteChat(id) { await db.collection("chats").doc(id).delete(); }
    async function showUserPassList() {
        const s = await db.collection("users").get();
        alert(s.docs.map(d => `${d.id}: ${d.data().pass}`).join("\n"));
    }
    function logout() { localStorage.removeItem("ntaro_user"); location.reload(); }
</script>
</body>
</html>
