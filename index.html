<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† å…¬å¼ã‚µã‚¤ãƒˆ | é€²åŒ–ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; --text-color: #333; --accent-pink: #FF6B6B; --sub-blue: #EAF4FF; --fever-gold: #FFD700; }
        body { font-family: "Hiragino Maru Gothic Pro", "Yu Gothic", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; }
        header { background: linear-gradient(135deg, #fff, var(--sub-blue)); padding: 40px 20px; text-align: center; border-bottom: 5px solid var(--main-blue); }
        h1 { margin: 0; color: var(--main-blue); font-size: 2.5em; text-shadow: 2px 2px 0px #fff; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; background: #fff; }
        
        /* ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¨ãƒªã‚¢ */
        .hero { background-color: var(--sub-blue); padding: 30px; border-radius: 20px; margin-bottom: 40px; text-align: center; position: relative; overflow: hidden; }
        .char-img { max-width: 180px; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.1)); transition: 0.3s; cursor: pointer; }
        .char-img:active { transform: scale(1.2) rotate(10deg); } /* ã‚¯ãƒªãƒƒã‚«ãƒ¼è¦ç´  */

        /* ã‚“ãŸã‚ã†ã®æ•™ãˆï¼ˆè¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰ */
        .wisdom-box { background: #fff; border-left: 5px solid var(--accent-pink); padding: 15px; margin: 20px 0; font-style: italic; text-align: left; }

        /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        #game-section { background: #222; color: #fff; padding: 20px; border-radius: 20px; position: relative; }
        #game-container { position: relative; width: 100%; height: 400px; background-color: #111; border: 2px solid #444; border-radius: 10px; overflow: hidden; touch-action: none; }
        #player { position: absolute; bottom: 10px; width: 60px; z-index: 10; pointer-events: none; filter: brightness(1.2); }
        .kusu { position: absolute; font-size: 20px; }
        .fever-mode { animation: fever-bg 0.5s infinite; }
        @keyframes fever-bg { 0% { background: #111; } 50% { background: #330000; } 100% { background: #111; } }
        
        /* ãƒœã‚¿ãƒ³ãƒ»UI */
        .btn { padding: 12px 30px; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--main-blue); color: white; }
        #fever-gauge-container { width: 100%; height: 10px; background: #444; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        #fever-bar { width: 0%; height: 100%; background: var(--fever-gold); transition: 0.1s; }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        .ranking-list { background: #fff; border-radius: 15px; border: 2px solid var(--sub-blue); overflow: hidden; color: #333; }
        .ranking-item { display: flex; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid #eee; }
        .ranking-item:first-child { background: #fff9c4; font-weight: bold; }
        .new-label { background: var(--accent-pink); color: #fff; font-size: 0.7em; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; z-index: 3000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #fff; margin: 20% auto; padding: 30px; width: 80%; max-width: 400px; border-radius: 20px; text-align: center; color: #333; }
    </style>
</head>
<body>

    <header>
        <h1>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† å…¬å¼</h1>
        <p>ã€œ å¤±æ•—ã‚’ã€æ˜æ—¥ã®å‹‡æ°—ã«å¤‰ãˆã‚‹å ´æ‰€ ã€œ</p>
    </header>

    <div class="container">
        <section class="hero">
            <img src="image_b322c7.png" alt="ã‚“ãŸã‚ã†" class="char-img" id="click-ntaro">
            <p><strong>ä¸Šã®ã€Œã‚“ãŸã‚ã†ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã¿ã‚ˆã†ï¼</strong></p>
            <div class="wisdom-box">
                <strong>ã‚“ãŸã‚ã†ã®æ ¼è¨€ï¼š</strong><br>
                ã€ŒçœŸã£ç™½ãªãƒãƒ¼ãƒˆã‚‚ã„ã„ã‘ã‚Œã©ã€æ¶ˆã—è·¡ãŒã‚ã‚‹ãƒãƒ¼ãƒˆã¯ã€å›ãŒæŒ‘æˆ¦ã—ãŸè¨¼æ‹ ãªã‚“ã ã‚ˆã€‚ã€
            </div>
            
            <div class="profile-card" style="text-align: left; padding: 20px; border: 1px solid #ddd; border-radius: 10px;">
                <h3 style="margin-top:0; color:var(--main-blue);">âœ¨ ã‚“ãŸã‚ã†ã®ç§˜å¯†ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰</h3>
                <p>å®Ÿã¯ã‚“ãŸã‚ã†ã€æ˜”ã¯ã€Œä¿®æ­£ãƒšãƒ³ã€ã«æ†§ã‚Œã¦ã„ã¾ã—ãŸã€‚ã§ã‚‚ã€è‡ªåˆ†ã®èº«ã‚’å‰Šã£ã¦ã§ã‚‚ã€Œã‚„ã‚Šç›´ã›ã‚‹ãƒãƒ£ãƒ³ã‚¹ã€ã‚’æ®‹ã›ã‚‹ä»Šã®ä»•äº‹ã«èª‡ã‚Šã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã¡ãªã¿ã«ã€å¥½ããªéŸ³æ¥½ã¯ã€Œã‚´ã‚·ã‚´ã‚·ã€ã¨ã„ã†æ‘©æ“¦éŸ³ã§ã™ã€‚</p>
            </div>
        </section>

        <section id="game-section">
            <h2 style="color:var(--fever-gold);">é€²åŒ–ã—ãŸï¼æ¶ˆã—ã‚«ã‚¹ã‚­ãƒ£ãƒƒãƒ</h2>
            <div id="fever-gauge-container"><div id="fever-bar"></div></div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <div id="score-board">ã‚¹ã‚³ã‚¢: 0</div>
                <div id="timer">æ®‹ã‚Šæ™‚é–“: 60s</div>
            </div>

            <div id="game-container">
                <img src="image_b322c7.png" id="player">
                <div id="start-screen" style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100;">
                    <button class="btn btn-main" onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                    <p style="font-size: 0.8em; margin-top: 10px;">ï¼ˆçˆ†å¼¾ğŸ’£ã‚’é¿ã‘ã¦ã€æ˜Ÿâ­ã¨ã‚«ã‚¹â˜ï¸ã‚’æ‹¾ãˆï¼ï¼‰</p>
                </div>
            </div>
        </section>

        <section>
            <h2 class="title" style="background:var(--main-blue); color:#fff; padding:5px 20px; border-radius:20px;">ğŸ† ä¸–ç•Œãƒ©ãƒ³ã‚­ãƒ³ã‚° (æœ€æ–°ã‚¹ã‚³ã‚¢å„ªå…ˆ)</h2>
            <div class="ranking-list" id="ranking-display">èª­ã¿è¾¼ã¿ä¸­...</div>
        </section>
    </div>

    <div id="scoreModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--accent-pink);">çµ‚äº†ï¼</h2>
            <p>ã‚ãªãŸã®è¨˜éŒ²: <span id="final-score" style="font-size:2em; font-weight:bold;">0</span></p>
            <input type="text" id="rankingName" placeholder="åå‰(5æ–‡å­—)" maxlength="5">
            <button class="btn btn-main" id="saveScoreBtn" onclick="saveScoreToFirebase()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²</button>
        </div>
    </div>

    <footer>&copy; 2024 æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†ã‚’å®ˆã‚‹ä¼š - å…¨ã¦ã®å¤±æ•—ã‚’æ„›ã™ã‚‹äººã«ã€‚</footer>

    <script>
        // FirebaseåˆæœŸåŒ–ï¼ˆã‚ãªãŸã®è¨­å®šã‚’ä¿æŒï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw",
            authDomain: "keshigomuuu-f5183.firebaseapp.com",
            projectId: "keshigomuuu-f5183",
            storageBucket: "keshigomuuu-f5183.firebasestorage.app",
            messagingSenderId: "541731028448",
            appId: "1:541731028448:web:512938a4ca14e61842bf85",
            measurementId: "G-8H0QH3TMZN"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- ä¸‹ãƒã‚¿ãƒ»NGãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ ---
        const ngWords = ["æ­»ã­", "æ®ºã™", "ã†ã‚“ã“", "ã¡ã‚“ã“", "ã¾ã‚“ã“", "ã‚»ãƒƒ", "sex"]; 
        function filterName(name) {
            let clean = name;
            ngWords.forEach(word => {
                if(clean.includes(word)) clean = "ç´³å£«";
            });
            return clean;
        }

        // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ï¼ˆæœ€æ–°é †ã‚½ãƒ¼ãƒˆå¯¾å¿œï¼‰ ---
        async function saveScoreToFirebase() {
            const rawName = document.getElementById('rankingName').value || "ãªãªã—";
            const name = filterName(rawName);
            const scoreVal = parseInt(document.getElementById('final-score').innerText);
            const btn = document.getElementById('saveScoreBtn');
            btn.disabled = true;
            try {
                // dateã‚’å…¥ã‚Œã¦ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€ŒåŒç‚¹ãªã‚‰æ–°ã—ã„äººãŒä¸Šã€ã‚’å¯èƒ½ã«ã™ã‚‹
                await db.collection("ranking").add({ name: name, score: scoreVal, date: firebase.firestore.FieldValue.serverTimestamp() });
                document.getElementById('scoreModal').style.display = 'none';
            } catch(e) { console.error(e); }
            btn.disabled = false;
        }

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ï¼ˆã‚¹ã‚³ã‚¢é™é † â” æ—¥ä»˜é™é †ï¼‰
        function loadRanking() {
            db.collection("ranking")
              .orderBy("score", "desc")
              .orderBy("date", "desc") // ã“ã‚Œã§ã€Œå¤ã„äººã¯ä¸‹ã€ã«ãªã‚‹
              .limit(10)
              .onSnapshot(snapshot => {
                const display = document.getElementById('ranking-display');
                display.innerHTML = snapshot.docs.map((doc, i) => {
                    const data = doc.data();
                    const isNew = data.date && (Date.now() - data.date.toMillis() < 300000); // 5åˆ†ä»¥å†…ãªã‚‰NEW
                    return `<div class="ranking-item">
                        <span>${i+1}ä½: ${data.name}${isNew ? '<span class="new-label">NEW</span>' : ''}</span>
                        <span>${data.score}ç‚¹</span>
                    </div>`;
                }).join('') || "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
            });
        }

        // --- é€²åŒ–ã—ãŸã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ ---
        const container = document.getElementById('game-container');
        const player = document.getElementById('player');
        const feverBar = document.getElementById('fever-bar');
        let score = 0, gameActive = false, timeLeft = 60, feverPoints = 0, isFever = false;

        // ã‚¯ãƒªãƒƒã‚«ãƒ¼è¦ç´ 
        document.getElementById('click-ntaro').addEventListener('click', () => {
            if(gameActive) {
                score += 1;
                feverPoints += 5;
                updateUI();
            }
        });

        function movePlayer(clientX) {
            if(!gameActive) return;
            const rect = container.getBoundingClientRect();
            let x = clientX - rect.left - (player.offsetWidth / 2);
            if(x < 0) x = 0; if(x > rect.width - player.offsetWidth) x = rect.width - player.offsetWidth;
            player.style.left = x + 'px';
        }
        container.addEventListener('mousemove', (e) => movePlayer(e.clientX));
        container.addEventListener('touchmove', (e) => { e.preventDefault(); movePlayer(e.touches[0].clientX); }, {passive: false});

        function startGame() {
            gameActive = true; score = 0; timeLeft = 60; feverPoints = 0; isFever = false;
            updateUI();
            document.getElementById('start-screen').style.display = 'none';
            spawnItem();
            let timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}s`;
                if(timeLeft <= 0) {
                    gameActive = false; clearInterval(timer);
                    document.getElementById('final-score').innerText = score;
                    document.getElementById('scoreModal').style.display = 'block';
                    document.getElementById('start-screen').style.display = 'flex';
                }
            }, 1000);
        }

        function updateUI() {
            document.getElementById('score-board').innerText = `ã‚¹ã‚³ã‚¢: ${score}`;
            feverBar.style.width = Math.min(feverPoints, 100) + '%';
            if(feverPoints >= 100 && !isFever) triggerFever();
        }

        function triggerFever() {
            isFever = true;
            container.classList.add('fever-mode');
            setTimeout(() => {
                isFever = false;
                feverPoints = 0;
                container.classList.remove('fever-mode');
                updateUI();
            }, 5000);
        }

        function spawnItem() {
            if(!gameActive) return;
            const item = document.createElement('div');
            item.className = 'kusu';
            const rnd = Math.random();
            let type = 'common';
            if(rnd < 0.1) type = 'bomb';  // çˆ†å¼¾
            else if(rnd < 0.2) type = 'star'; // ãƒœãƒ¼ãƒŠã‚¹

            item.innerText = (type === 'bomb') ? 'ğŸ’£' : (type === 'star' ? 'â­' : 'â˜ï¸');
            item.style.left = Math.random() * (container.offsetWidth - 30) + 'px';
            item.style.top = '0px';
            container.appendChild(item);

            let speed = isFever ? 10 : (4 + score / 200);
            let fall = setInterval(() => {
                let top = parseInt(item.style.top);
                item.style.top = (top + speed) + 'px';
                
                const pR = player.getBoundingClientRect(), iR = item.getBoundingClientRect();
                if (!(pR.top > iR.bottom || pR.bottom < iR.top || pR.left > iR.right || pR.right < iR.left)) {
                    if(type === 'bomb') { score = Math.max(0, score - 50); feverPoints = 0; }
                    else if(type === 'star') { score += 30; feverPoints += 15; }
                    else { score += 10; feverPoints += 5; }
                    updateUI();
                    item.remove(); clearInterval(fall);
                }
                if (top > container.offsetHeight) { item.remove(); clearInterval(fall); }
            }, 20);
            setTimeout(spawnItem, isFever ? 150 : 500);
        }

        loadRanking();
    </script>
</body>
</html>
