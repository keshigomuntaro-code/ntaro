<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† çœŸãƒ»å®Œå…¨ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; --text-color: #333; --sub-blue: #EAF4FF; --fever-gold: #FFD700; }
        body { font-family: "Hiragino Maru Gothic Pro", "Yu Gothic", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); text-align: center; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ */
        .account-bar { background: var(--main-blue); color: #fff; padding: 10px; font-size: 0.85em; font-weight: bold; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€š */
        section { margin-bottom: 20px; padding: 20px; border-radius: 20px; background: #fff; border: 2px solid var(--sub-blue); position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }

        /* æ¶ˆã—ã‚´ãƒ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆå¾©æ´»ï¼ï¼‰ */
        .hero { display: flex; align-items: center; gap: 20px; text-align: left; }
        .hero img { width: 90px; height: 90px; object-fit: contain; }
        .hero-info { flex: 1; }
        .hero-info b { font-size: 1.1em; color: var(--main-blue); }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-container { position: relative; width: 100%; height: 350px; background-color: var(--sub-blue); border-radius: 15px; overflow: hidden; border: 2px solid #ddd; cursor: none; }
        #player { position: absolute; bottom: 10px; width: 60px; z-index: 10; pointer-events: none; }
        .kusu { position: absolute; font-size: 30px; z-index: 5; pointer-events: none; }

        /* ãƒªã‚¹ãƒˆãƒ»ã‚«ãƒ¼ãƒ‰ */
        .grid-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; }
        .card { width: 85px; padding: 10px; border: 2px solid #ddd; border-radius: 12px; cursor: pointer; font-size: 0.65em; background: #fff; transition: 0.2s; }
        .card.selected { border-color: var(--main-blue); background: var(--sub-blue); border-width: 3px; transform: scale(1.05); }

        /* ãƒãƒ£ãƒƒãƒˆï¼ˆå¹ãå‡ºã—å¾©æ´»ï¼ï¼‰ */
        .chat-container { text-align: left; height: 280px; overflow-y: auto; padding: 15px; background: #f0f2f5; border-radius: 15px; margin-bottom: 10px; }
        .chat-bubble { display: inline-block; background: #fff; border-radius: 15px; padding: 8px 15px; margin-bottom: 10px; max-width: 80%; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); clear: both; float: left; }
        .chat-bubble.mine { background: #DCF8C6; float: right; }
        .chat-bubble b { display: block; font-size: 0.7em; color: var(--main-blue); margin-bottom: 2px; }

        /* ãƒœã‚¿ãƒ³ãƒ»ç®¡ç†ãƒ‘ãƒãƒ« */
        .btn { padding: 10px 20px; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; background: var(--main-blue); color: #fff; }
        .adm-panel { background: #1a1a1a; color: #00ff41; padding: 15px; font-size: 0.8em; border-radius: 15px; display: none; text-align: left; border: 1px solid #00ff41; margin-bottom: 20px; }
        .badge { font-size: 0.75em; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 5px; background: #666; font-weight: bold; }
        .badge-admin { background: #000; color: #ffd700; border: 1px solid #ffd700; }
    </style>
</head>
<body>
    <div id="ban-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:red; z-index:100000; justify-content:center; align-items:center; flex-direction:column;">
        <h1>ACCESS DENIED</h1><p>è¿½æ”¾ã•ã‚Œã¾ã—ãŸã€‚</p>
    </div>

    <div class="account-bar">
        <div onclick="changeMyName()">ğŸ‘¤ <span id="my-badge-area"></span><span id="display-user">...</span></div>
        <div>ğŸ’° <span id="kp-display">0</span> KP</div>
    </div>

    <div class="container">
        <header><h1>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† <span style="font-size:0.4em; opacity:0.5;">å®Œå…¨å¾©æ´»ç‰ˆ</span></h1></header>

        <section class="hero">
            <img src="image_b322c7.png" id="hero-img">
            <div class="hero-info">
                <b>æ¶ˆã—ã‚´ãƒ ç´¹ä»‹</b><br>
                <span>é–“é•ã„ã‚’æ¶ˆã—å»ã‚‹ãƒ’ãƒ¼ãƒ­ãƒ¼ã€‚èº«ã‚’å‰Šã£ã¦åƒãã€ã¿ã‚“ãªã®å‘³æ–¹ã€‚</span>
            </div>
        </section>

        <section id="adm-panel" class="adm-panel">
            <b>ã€é‹å–¶ç®¡ç†ãƒ„ãƒ¼ãƒ«ã€‘</b><hr>
            å¯¾è±¡: <select id="adm-user-select"></select><br>
            ç§°å·: <select id="adm-title-select">
                <option value="æ–°äºº">æ–°äºº</option>
                <option value="ç¥">ç¥ (ã‚¹ã‚³ã‚¢3å€)</option>
                <option value="ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼">ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼ (é€Ÿ)</option>
                <option value="é‰„å£">é‰„å£ (ç„¡æ•µ)</option>
                <option value="ç®¡ç†äºº">ç®¡ç†äºº (æœ€å¼·)</option>
            </select>
            <button onclick="admGiveTitle()">ä»˜ä¸</button>
            <button onclick="admBan()" style="background:red;">IP BAN</button>
            <button onclick="addKP(100000)">+10ä¸‡KP</button>
        </section>

        <section id="game-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; font-size:0.9em;">
                <span id="score-board">ã‚¹ã‚³ã‚¢: 0</span>
                <span id="timer">æ®‹ã‚Š: 45s</span>
            </div>
            <div id="game-container">
                <img src="image_b322c7.png" id="player">
                <div id="start-screen" style="position:absolute; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100;">
                    <button class="btn" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                </div>
            </div>
        </section>

        <section>
            <h4>ğŸ ç‰¹æ€§ã‚¬ãƒãƒ£ (500KP)</h4>
            <button class="btn" onclick="drawGacha()" style="background:#f39c12; width:100%; margin-bottom:15px;">ã‚¬ãƒãƒ£ã‚’å›ã™</button>
            <div class="grid-list" id="skin-list"></div>
        </section>

        <section>
            <h4>ğŸ·ï¸ ç§°å·ä¸€è¦§ï¼ˆãƒãƒ•é©ç”¨ï¼‰</h4>
            <div class="grid-list" id="title-list"></div>
        </section>

        <section>
            <h4>ğŸ’¬ æ²ç¤ºæ¿</h4>
            <div class="chat-container" id="chat-display"></div>
            <div style="display:flex; gap:5px;"><input type="text" id="chat-msg" style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd;"><button class="btn" onclick="sendChat()">é€ä¿¡</button></div>
        </section>
    </div>

    <div onclick="toggleBackworld()" style="position:fixed; bottom:0; right:0; width:40px; height:40px; opacity:0; z-index:10000;"></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw", authDomain: "keshigomuuu-f5183.firebaseapp.com", projectId: "keshigomuuu-f5183", storageBucket: "keshigomuuu-f5183.firebasestorage.app", messagingSenderId: "541731028448", appId: "1:541731028448:web:512938a4ca14e61842bf85" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let myName = localStorage.getItem("ntaro_user") || "";
        let userData = { kp: 0, skins: ['normal'], titles: ['æ–°äºº'], currentSkin: 'normal', currentTitle: 'æ–°äºº', ip: "" };
        let gameActive = false, score = 0, myIp = "";

        const SKINS = {
            'normal': { name: 'å…ƒç¥–', filter: 'none' },
            'red': { name: 'ç´…', filter: 'hue-rotate(300deg) saturate(2)' },
            'blue': { name: 'è’¼', filter: 'hue-rotate(180deg)' },
            'gold': { name: 'é»„é‡‘', filter: 'sepia(1) saturate(10) brightness(1.2)' }
        };

        const TITLE_BUFFS = {
            'ç¥': { scoreMult: 3, speed: 1 },
            'ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼': { scoreMult: 1, speed: 2 },
            'é‰„å£': { scoreMult: 1, speed: 1, invincible: true },
            'ç®¡ç†äºº': { scoreMult: 5, speed: 2, invincible: true },
            'æ–°äºº': { scoreMult: 1, speed: 1 }
        };

        window.onload = async () => {
            const res = await fetch('https://api.ipify.org?format=json');
            const data = await res.json(); myIp = data.ip;
            checkBan();
            if(!myName) login(); else init();
        };

        async function checkBan() {
            const snap = await db.collection("banlist").doc(myIp).get();
            if(snap.exists) document.getElementById("ban-screen").style.display = "flex";
        }

        async function login() {
            let n = prompt("åå‰ã‚’å…¥åŠ›"); if(!n) return;
            const r = db.collection("users").doc(n), d = await r.get();
            if(d.exists) { if(prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")===d.data().pass) { myName=n; init(); } else login(); }
            else { let p=prompt("æ–°è¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"); await r.set({pass:p, kp:0, skins:['normal'], titles:['æ–°äºº'], currentSkin:'normal', currentTitle:'æ–°äºº', ip: myIp}); myName=n; init(); }
            localStorage.setItem("ntaro_user", myName);
        }

        function init() {
            db.collection("users").doc(myName).onSnapshot(doc => {
                userData = doc.data();
                document.getElementById("display-user").innerText = myName;
                document.getElementById("kp-display").innerText = userData.kp.toLocaleString();
                document.getElementById("my-badge-area").innerHTML = `<span class="badge ${userData.currentTitle==='ç®¡ç†äºº'?'badge-admin':''}">${userData.currentTitle}</span>`;
                renderSkins(); renderTitles();
            });
            loadChat();
            db.collection("users").onSnapshot(s => {
                document.getElementById("adm-user-select").innerHTML = s.docs.map(d => `<option value="${d.id}">${d.id}</option>`).join('');
            });
        }

        // ãƒã‚¦ã‚¹æ“ä½œ
        const container = document.getElementById('game-container');
        const player = document.getElementById('player');
        container.addEventListener('mousemove', (e) => {
            if(!gameActive) return;
            const rect = container.getBoundingClientRect();
            let x = e.clientX - rect.left - (player.offsetWidth / 2);
            x = Math.max(0, Math.min(x, rect.width - player.offsetWidth));
            player.style.left = x + 'px';
        });

        function startGame() {
            score = 0; gameActive = true;
            document.getElementById('start-screen').style.display = 'none';
            spawnLoop();
        }

        function spawnLoop() {
            if(!gameActive) return;
            spawnItem();
            setTimeout(spawnLoop, 600);
        }

        function spawnItem() {
            const it = document.createElement('div'); it.className = 'kusu';
            it.innerText = (Math.random() < 0.15) ? 'ğŸ’£' : (Math.random() < 0.45 ? 'â­' : 'â˜ï¸');
            it.style.left = Math.random() * (container.offsetWidth - 30) + 'px';
            it.style.top = '-40px';
            container.appendChild(it);

            const buff = TITLE_BUFFS[userData.currentTitle] || {speed:1, scoreMult:1};
            let fall = setInterval(() => {
                if(!gameActive) { it.remove(); clearInterval(fall); return; }
                let t = parseInt(it.style.top); it.style.top = (t + (5 * buff.speed)) + 'px';
                
                const pR = player.getBoundingClientRect(), iR = it.getBoundingClientRect();
                if (!(pR.top > iR.bottom || pR.bottom < iR.top || pR.left > iR.right || pR.right < iR.left)) {
                    if(it.innerText === 'ğŸ’£' && !buff.invincible) { gameActive = false; alert("GAME OVER"); document.getElementById('start-screen').style.display='flex'; }
                    else if(it.innerText === 'â­') { score += 30 * buff.scoreMult; }
                    document.getElementById('score-board').innerText = "ã‚¹ã‚³ã‚¢: " + score;
                    it.remove(); clearInterval(fall);
                }
                if(t > 400) { it.remove(); clearInterval(fall); }
            }, 20);
        }

        // ç®¡ç†ç³»
        function toggleBackworld() { if(prompt("è£ã‚³ãƒ¼ãƒ‰")==="keshi99") document.getElementById('adm-panel').style.display='block'; }
        async function admGiveTitle() {
            const target = document.getElementById("adm-user-select").value;
            const title = document.getElementById("adm-title-select").value;
            await db.collection("users").doc(target).update({ titles: firebase.firestore.FieldValue.arrayUnion(title) });
            alert("ä»˜ä¸å®Œäº†");
        }
        async function admBan() {
            const target = document.getElementById("adm-user-select").value;
            const snap = await db.collection("users").doc(target).get();
            if(snap.exists) await db.collection("banlist").doc(snap.data().ip).set({ banned: true });
        }
        async function addKP(v) { await db.collection("users").doc(myName).update({ kp: firebase.firestore.FieldValue.increment(v) }); }

        // ã‚¹ã‚­ãƒ³ãƒ»ç§°å·
        function renderSkins() {
            document.getElementById('skin-list').innerHTML = Object.keys(SKINS).map(k => {
                const s = SKINS[k]; const locked = !userData.skins.includes(k);
                return `<div class="card ${locked?'locked':''} ${userData.currentSkin===k?'selected':''}" onclick="setSkin('${k}')">
                    <img src="image_b322c7.png" style="width:40px; filter:${s.filter}"><br><b>${s.name}</b></div>`;
            }).join('');
            player.style.filter = SKINS[userData.currentSkin].filter;
            document.getElementById('hero-img').style.filter = SKINS[userData.currentSkin].filter;
        }
        async function setSkin(k) { if(userData.skins.includes(k)) await db.collection("users").doc(myName).update({ currentSkin: k }); }
        
        function renderTitles() {
            document.getElementById('title-list').innerHTML = userData.titles.map(t => {
                return `<div class="card ${userData.currentTitle===t?'selected':''}" style="width:auto; min-width:80px;" onclick="setTitle('${t}')">${t}</div>`;
            }).join('');
        }
        async function setTitle(t) { await db.collection("users").doc(myName).update({ currentTitle: t }); }

        async function drawGacha() {
            if(userData.kp < 500) return alert("KPä¸è¶³");
            await db.collection("users").doc(myName).update({ kp: userData.kp - 500 });
            const keys = Object.keys(SKINS); const res = keys[Math.floor(Math.random()*keys.length)];
            await db.collection("users").doc(myName).update({ skins: firebase.firestore.FieldValue.arrayUnion(res) });
            alert("ç²å¾—ã—ã¾ã—ãŸï¼");
        }

        // ãƒãƒ£ãƒƒãƒˆ
        function loadChat() { db.collection("chats").orderBy("date","asc").limitToLast(15).onSnapshot(s => {
            document.getElementById('chat-display').innerHTML = s.docs.map(d => {
                const isMine = d.data().name === myName ? 'mine' : '';
                return `<div class="chat-bubble ${isMine}"><b>${d.data().name}</b>${d.data().msg}</div>`;
            }).join('');
            document.getElementById('chat-display').scrollTop = 999;
        });}
        async function sendChat() { const m = document.getElementById('chat-msg').value; if(m){ await db.collection("chats").add({name:myName, msg:m, date:new Date()}); document.getElementById('chat-msg').value=""; } }
    </script>
</body>
</html>
