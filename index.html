<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; }
        body { font-family: sans-serif; margin: 0; background: var(--bg-color); text-align: center; }
        header { background: #fff; padding: 10px; border-bottom: 3px solid var(--main-blue); }
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }
        section { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* ã‚²ãƒ¼ãƒ  */
        #game-container { position: relative; width: 100%; height: 300px; background: #eef; border-radius: 5px; overflow: hidden; touch-action: none; }
        #player { position: absolute; bottom: 5px; width: 50px; }
        .kusu { position: absolute; font-size: 25px; }

        /* ãƒãƒ£ãƒƒãƒˆ */
        .chat-box { text-align: left; height: 250px; overflow-y: auto; background: #fff; border: 1px solid #ccc; padding: 10px; font-size: 0.9em; }
        .chat-line { margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 2px; cursor: pointer; }
        .chat-name { font-weight: bold; color: var(--main-blue); }
        
        /* ãƒªã‚¹ãƒˆ */
        .list-box { text-align: left; background: #fafafa; border: 1px solid #ddd; height: 100px; overflow-y: auto; font-size: 0.8em; padding: 5px; }
        .list-item { display: flex; justify-content: space-between; padding: 2px 0; cursor: pointer; }

        .btn { padding: 8px 15px; border: none; border-radius: 4px; background: var(--main-blue); color: #fff; font-weight: bold; cursor: pointer; margin: 2px; }
        .btn-red { background: #d9534f; }
        .btn-purple { background: #5e5ce6; }
        .btn-gold { background: #f0ad4e; color: #000; }

        /* ç››ã‚Šã ãã•ã‚“ç®¡ç†ãƒ‘ãƒãƒ« */
        #admin-panel { display:none; position:fixed; bottom:0; left:0; width:100%; max-height: 80%; overflow-y: auto; background:#222; color:#fff; padding:20px; box-sizing:border-box; z-index:1000; border-top: 4px solid gold; text-align: left; }
        .admin-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .admin-section { border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; }
        label { font-size: 0.7em; color: #aaa; display: block; }
    </style>
</head>
<body>
    <div id="ban-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; color:#fff; z-index:9999; justify-content:center; align-items:center;"><h1>ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢</h1></div>

    <header><h1>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†</h1></header>

    <div class="container">
        <div style="font-size:0.8em; margin-bottom:10px;">ğŸ‘¤ï¼š<span id="display-user">ã‚²ã‚¹ãƒˆ</span> <span id="my-badge"></span></div>

        <section id="game-area">
            <div style="display:flex; justify-content:space-between; font-size:0.9em; font-weight:bold; margin-bottom:5px;">
                <span id="score-board">ã‚¹ã‚³ã‚¢: 0</span><span id="timer">æ®‹ã‚Š: 45</span>
            </div>
            <div id="game-container">
                <img src="image_b322c7.png" id="player">
                <div id="start-screen" style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center;">
                    <button class="btn" onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                </div>
            </div>
        </section>

        <section style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>ãƒ­ã‚°<div class="list-box" id="log-display"></div></div>
            <div>é †ä½<div class="list-box" id="ranking-display"></div></div>
        </section>

        <section>
            <div class="chat-box" id="chat-display"></div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="text" id="chat-msg" style="flex:1; padding:8px;" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸...">
                <button class="btn" onclick="sendChat()">é€ä¿¡</button>
            </div>
        </section>
    </div>

    <div id="admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; color:gold;">MASTER CONTROL</h2>
            <button class="btn" onclick="document.getElementById('admin-panel').style.display='none'" style="background:#555;">é–‰ã˜ã‚‹</button>
        </div>

        <div class="admin-section">
            <label>å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
            <input type="text" id="target-name" placeholder="åå‰ã‚’å…¥åŠ›..." style="width:100%; padding:10px; box-sizing:border-box; border-radius:4px; border:none;">
            <div class="admin-grid">
                <button class="btn btn-gold" onclick="quickTitle('ç®¡ç†äºº')">ç§°å·[ç®¡ç†äºº]</button>
                <button class="btn btn-gold" onclick="quickTitle('æ¶ˆã—ã‚´ãƒ è·äºº')">ç§°å·[è·äºº]</button>
                <button class="btn btn-gold" onclick="setCustomTitle()">ã‚«ã‚¹ã‚¿ãƒ ç§°å·</button>
                <button class="btn btn-red" onclick="quickBan()">IP/UID BAN</button>
                <button class="btn btn-purple" onclick="renameAccount()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ”¹å</button>
                <button class="btn" onclick="forceUnlockID()">IDç´ä»˜è§£é™¤</button>
            </div>
        </div>

        <div class="admin-section">
            <label>ã‚·ã‚¹ãƒ†ãƒ ãƒ»å…¨ä½“æ“ä½œ</label>
            <div class="admin-grid">
                <button class="btn btn-red" onclick="clearAllChats()">ãƒãƒ£ãƒƒãƒˆå…¨æ¶ˆå»</button>
                <button class="btn btn-red" onclick="resetAllRanking()">é †ä½å…¨ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="btn btn-purple" onclick="sendSystemAlert()">ç·Šæ€¥å…¨ä½“é€šçŸ¥</button>
                <button class="btn btn-purple" onclick="addCustomLog()">å…¬å¼ãƒ­ã‚°è¿½åŠ </button>
                <button class="btn" onclick="checkBanList()">BANãƒªã‚¹ãƒˆç¢ºèª</button>
                <button class="btn" onclick="unBanTarget()">BANè§£é™¤</button>
            </div>
        </div>
    </div>

    <div onclick="openAdminPanel()" style="position:fixed; bottom:0; right:0; width:40px; height:40px; opacity:0.1; cursor:pointer; z-index:9999;">âš™ï¸</div>

    <script>
        // è¨­å®šéƒ¨åˆ†ã¯å‰è¿°ã¨åŒã˜
        const firebaseConfig = { apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw", authDomain: "keshigomuuu-f5183.firebaseapp.com", projectId: "keshigomuuu-f5183", storageBucket: "keshigomuuu-f5183.firebasestorage.app", messagingSenderId: "541731028448", appId: "1:541731028448:web:512938a4ca14e61842bf85" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const ADMIN_PASS = "keshi99";

        let myID = localStorage.getItem("ntaro_id") || "ID_" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("ntaro_id", myID);
        let myName = localStorage.getItem("ntaro_user") || "";
        let myTitle = "";
        let pt;

        window.onload = () => { syncData(); initAccount(); listenSystemAlert(); };

        function syncData() {
            db.collection("chats").orderBy("date", "asc").limitToLast(30).onSnapshot(s => {
                document.getElementById('chat-display').innerHTML = s.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="chat-line" oncontextmenu="openAdminMenu('${d.uid}','${d.name}','chats','${doc.id}','${d.msg}');return false;" ontouchstart="handleLongPress(()=>openAdminMenu('${d.uid}','${d.name}','chats','${doc.id}','${d.msg}'))">
                        <span class="chat-name">${d.title ? '['+d.title+']' : ''}${d.name}</span>: ${d.msg}
                    </div>`;
                }).join('');
                document.getElementById('chat-display').scrollTop = 9999;
            });
            db.collection("logs").orderBy("date", "desc").limit(10).onSnapshot(s => {
                document.getElementById('log-display').innerHTML = s.docs.map(doc => `<div>ãƒ»${doc.data().text}</div>`).join('');
            });
            db.collection("ranking").orderBy("score", "desc").limit(10).onSnapshot(s => {
                document.getElementById('ranking-display').innerHTML = s.docs.map((doc, i) => `
                <div class="list-item" oncontextmenu="openAdminMenu('${doc.data().uid}','${doc.data().name}','ranking','${doc.id}',${doc.data().score});return false;" ontouchstart="handleLongPress(()=>openAdminMenu('${doc.data().uid}','${doc.data().name}','ranking','${doc.id}',${doc.data().score}))">
                    <span>${i+1}.${doc.data().name}</span><b>${doc.data().score}</b>
                </div>`).join('');
            });
        }

        async function initAccount() {
            const b = await db.collection("bans").doc(myID).get();
            if(b.exists) { document.body.innerHTML = "<h1>ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢</h1>"; return; }
            if (myName) {
                const d = await db.collection("users").doc(myName).get();
                if(d.exists) {
                    if(d.data().uid !== myID && d.data().uid !== "RESET") { myName=""; localStorage.removeItem("ntaro_user"); location.reload(); return; }
                    if(d.data().uid === "RESET") await db.collection("users").doc(myName).update({uid: myID});
                    myTitle = d.data().title || "";
                    document.getElementById("my-badge").innerText = myTitle ? "["+myTitle+"]" : "";
                }
                document.getElementById("display-user").innerText = myName;
            } else login();
        }

        async function login() {
            let n = prompt("åå‰"); if(!n) return;
            const r = db.collection("users").doc(n); const d = await r.get();
            if(d.exists) {
                if(d.data().uid !== myID && d.data().uid !== "RESET") { alert("ä½¿ç”¨ä¸­"); return login(); }
                if(prompt("ãƒ‘ã‚¹") === d.data().pass) { myName=n; if(d.data().uid === "RESET") await r.update({uid: myID}); } else { alert("Ã—"); return login(); }
            } else {
                let p = prompt("æ–°ãƒ‘ã‚¹"); if(p) { await r.set({pass:p, uid:myID, title:""}); myName=n; }
            }
            localStorage.setItem("ntaro_user", myName); location.reload();
        }

        // --- ç››ã‚Šã ãã•ã‚“ç®¡ç†é–¢æ•° ---
        function openAdminPanel() { if(prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰") === ADMIN_PASS) document.getElementById('admin-panel').style.display = 'block'; }
        
        async function openAdminMenu(tid, tname, col, docId, val) {
            if(prompt("ç®¡ç†è€…æ¨©é™ç¢ºèª") !== ADMIN_PASS) return;
            let a = prompt("1:æ¶ˆå» 2:BAN 3:å€¤ç·¨é›† 4:åå‰å¤‰æ›´ 5:IDè§£é™¤");
            if(a==="1") await db.collection(col).doc(docId).delete();
            else if(a==="2") await db.collection("bans").doc(tid).set({name: tname, date: new Date()});
            else if(a==="3") { let v=prompt("å†…å®¹ã‚’æ”¹ç«„", val); if(v) await db.collection(col).doc(docId).update(col==='chats'?{msg:v}:{score:parseInt(v)}); }
            else if(a==="4") { let n=prompt("åå‰ã‚’æ›¸ãæ›ãˆ", tname); if(n) await db.collection(col).doc(docId).update({name: n}); }
            else if(a==="5") await db.collection("users").doc(tname).update({uid: "RESET"});
        }

        async function quickTitle(t) { const n = document.getElementById('target-name').value; if(n) await db.collection("users").doc(n).update({title: t}); }
        async function setCustomTitle() { const n = document.getElementById('target-name').value; const t = prompt("ã‚«ã‚¹ã‚¿ãƒ ç§°å·ã‚’å…¥åŠ›"); if(n && t) await db.collection("users").doc(n).update({title: t}); }
        async function quickBan() { const n = document.getElementById('target-name').value; const u = await db.collection("users").doc(n).get(); if(u.exists) { await db.collection("bans").doc(u.data().uid).set({name: n}); alert(n + "ã‚’æ°¸ä¹…è¿½æ”¾ã—ã¾ã—ãŸ"); } }
        async function unBanTarget() { const n = document.getElementById('target-name').value; const s = await db.collection("bans").where("name","==",n).get(); s.forEach(d => d.ref.delete()); alert("BANè§£é™¤ã—ã¾ã—ãŸ"); }
        async function forceUnlockID() { const n = document.getElementById('target-name').value; if(n) await db.collection("users").doc(n).update({uid: "RESET"}); alert("ç´ä»˜ã‚’è§£æ”¾ã—ã¾ã—ãŸ"); }
        async function addCustomLog() { const t = prompt("ãƒ­ã‚°å†…å®¹"); if(t) await db.collection("logs").add({text:t, date: new Date()}); }
        
        async function clearAllChats() { if(confirm("å…¨ãƒãƒ£ãƒƒãƒˆã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { const s = await db.collection("chats").get(); const b = db.batch(); s.forEach(d => b.delete(d.ref)); await b.commit(); } }
        async function resetAllRanking() { if(confirm("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { const s = await db.collection("ranking").get(); const b = db.batch(); s.forEach(d => b.delete(d.ref)); await b.commit(); } }
        
        async function sendSystemAlert() { 
            const m = prompt("å…¨ä½“é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"); 
            if(m) await db.collection("system").doc("alert").set({msg: m, date: new Date()}); 
        }

        function listenSystemAlert() {
            db.collection("system").doc("alert").onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    const now = new Date().getTime();
                    if(now - data.date.toMillis() < 5000) { alert("ã€é‹å–¶é€šçŸ¥ã€‘\n" + data.msg); }
                }
            });
        }

        async function renameAccount() {
            const oldN = document.getElementById('target-name').value; const newN = prompt("æ–°ã—ã„åå‰");
            if(oldN && newN) {
                const r = db.collection("users").doc(oldN); const d = await r.get();
                if(d.exists) { await db.collection("users").doc(newN).set(d.data()); await r.delete(); alert("åå‰ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸ"); }
            }
        }

        async function checkBanList() {
            const s = await db.collection("bans").get();
            let list = s.docs.map(d => d.data().name).join(", ");
            alert("è¿½æ”¾è€…ãƒªã‚¹ãƒˆ:\n" + (list || "ãªã—"));
        }

        // --- GAME (ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ) ---
        let score = 0, gameActive = false, timeLeft = 45;
        function startGame() {
            if(!myName) return; score=0; timeLeft=45; gameActive=true;
            document.getElementById('start-screen').style.display='none';
            const ti = setInterval(() => {
                timeLeft--; document.getElementById('timer').innerText="æ®‹ã‚Š: "+timeLeft;
                if(timeLeft<=0 || !gameActive) {
                    clearInterval(ti); gameActive=false;
                    db.collection("ranking").add({uid:myID, name:myName, score, date: new Date()});
                    db.collection("logs").add({text: `${myName}ãŒ${score}ç‚¹ç²å¾—`, date: new Date()});
                    document.getElementById('start-screen').style.display='flex';
                }
            }, 1000);
            spawn();
        }
        function spawn() {
            if(!gameActive) return;
            const it = document.createElement('div'); it.className='kusu'; it.innerText = Math.random() < 0.2 ? 'ğŸ’£' : 'â­';
            it.style.left = Math.random()*(document.getElementById('game-container').offsetWidth-30)+'px'; it.style.top = '-40px';
            document.getElementById('game-container').appendChild(it);
            let f = setInterval(() => {
                if(!gameActive) { it.remove(); clearInterval(f); return; }
                let t = parseInt(it.style.top); it.style.top = (t + 6) + 'px';
                const pR = document.getElementById('player').getBoundingClientRect(), iR = it.getBoundingClientRect();
                if (!(pR.top > iR.bottom || pR.bottom < iR.top || pR.left > iR.right || pR.right < iR.left)) {
                    score += (it.innerText === 'ğŸ’£' ? -50 : 10);
                    document.getElementById('score-board').innerText = "ã‚¹ã‚³ã‚¢: " + score;
                    it.remove(); clearInterval(f);
                }
                if (t > 300) { it.remove(); clearInterval(f); }
            }, 20);
            setTimeout(spawn, 500);
        }
        async function sendChat() { const m = document.getElementById('chat-msg').value; if(m&&myName) await db.collection("chats").add({uid:myID, name:myName, msg:m, title:myTitle, date: new Date()}); document.getElementById('chat-msg').value=""; }
        function handleLongPress(f){ pt=setTimeout(f,800); }
        window.onmouseup=window.ontouchend=()=>clearTimeout(pt);
        function move(cx) { if(!gameActive) return; const rect = document.getElementById('game-container').getBoundingClientRect(); document.getElementById('player').style.left = (cx - rect.left - 25) + 'px'; }
        document.getElementById('game-container').addEventListener('mousemove', (e)=>move(e.clientX));
        document.getElementById('game-container').addEventListener('touchmove', (e)=>{ e.preventDefault(); move(e.touches[0].clientX); }, {passive:false});
    </script>
</body>
</html>
