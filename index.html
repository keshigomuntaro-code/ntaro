<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ê∂à„Åó„Ç¥„É†„Çì„Åü„Çç„ÅÜ ÂÆåÂÖ®Áâà</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; --text-color: #333; --sub-blue: #EAF4FF; --fever-gold: #FFD700; }
        body { font-family: "Hiragino Maru Gothic Pro", "Yu Gothic", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); text-align: center; }
        header { background: #fff; padding: 15px; border-bottom: 5px solid var(--main-blue); }
        .account-bar { background: var(--main-blue); color: #fff; padding: 8px; font-size: 0.8em; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        section { margin-bottom: 15px; padding: 15px; border-radius: 15px; background: #fff; border: 2px solid var(--sub-blue); }
        
        /* „É≠„Ç∞„Éª„É©„É≥„Ç≠„É≥„Ç∞ */
        .list-box { text-align: left; background: #fff; border-radius: 8px; padding: 8px; height: 120px; overflow-y: auto; border: 1px solid #eee; font-size: 0.75em; }
        .list-item { padding: 4px 0; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; cursor: pointer; }

        /* „ÉÅ„É£„ÉÉ„Éà */
        .chat-container { text-align: left; height: 280px; overflow-y: auto; padding: 10px; background: var(--sub-blue); border-radius: 10px; }
        .chat-bubble { display: flex; gap: 8px; background: #fff; border-radius: 10px; padding: 8px; margin-bottom: 6px; cursor: pointer; }
        .chat-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #ddd; }
        .chat-name { font-size: 0.7em; font-weight: bold; color: var(--main-blue); }
        
        /* „Ç≤„Éº„É† */
        #game-container { position: relative; width: 100%; height: 320px; background: var(--sub-blue); border-radius: 10px; overflow: hidden; touch-action: none; }
        #player { position: absolute; bottom: 10px; width: 60px; pointer-events: none; }
        .kusu { position: absolute; font-size: 28px; }

        .btn { padding: 8px 12px; font-weight: bold; border-radius: 20px; border: none; cursor: pointer; background: var(--main-blue); color: #fff; font-size: 0.8em; }
        #admin-panel { display:none; position:fixed; bottom:0; left:0; width:100%; background:#222; color:#fff; z-index:20000; padding:15px; box-sizing:border-box; }
        .badge { font-size: 0.7em; padding: 1px 4px; border-radius: 3px; color: white; margin-right: 3px; }
    </style>
</head>
<body>
    <div id="ban-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:white; z-index:30000; flex-direction:column; justify-content:center; align-items:center;">
        <h1>üö´ „Ç¢„ÇØ„Çª„ÇπÂà∂Èôê</h1><p>Êé•Á∂ö„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ</p>
        <button class="btn" onclick="location.href='mailto:admin@example.com'">Ëß£Èô§Áî≥Ë´ã</button>
    </div>

    <div id="main-content">
        <div class="account-bar"><img src="" id="my-top-icon" style="width:25px;height:25px;border-radius:50%;"><b id="display-user">„Ç≤„Çπ„Éà</b><span id="my-badge"></span></div>
        <header><h1>Ê∂à„Åó„Ç¥„É†„Çì„Åü„Çç„ÅÜ</h1></header>

        <div class="container">
            <section>
                <h4>üë§ „Éó„É≠„Éï„Ç£„Éº„É´</h4>
                <input type="text" id="set-icon" placeholder="„Ç¢„Ç§„Ç≥„É≥URL" style="width:45%;">
                <input type="text" id="set-bio" placeholder="„Å≤„Å®„Åì„Å®" style="width:45%;">
                <button class="btn" onclick="saveProfile()">‰øùÂ≠ò</button>
            </section>

            <section id="game-section">
                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:5px;">
                    <span id="score-board">SCORE: 0</span><span id="timer">TIME: 45</span>
                </div>
                <div id="game-container">
                    <img src="image_b322c7.png" id="player">
                    <div id="start-screen" style="position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:100;">
                        <button class="btn" onclick="startGame()">„Ç≤„Éº„É†ÈñãÂßã</button>
                    </div>
                </div>
            </section>

            <section style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>„É≠„Ç∞<div class="list-box" id="log-display"></div></div>
                <div>È†Ü‰Ωç(Èï∑Êäº„ÅóÊ∂àÂéª)<div class="list-box" id="ranking-display"></div></div>
            </section>

            <section>
                <div class="chat-container" id="chat-display"></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <input type="text" id="chat-msg" style="flex:1; padding:8px; border-radius:10px; border:1px solid #ddd;">
                    <button class="btn" onclick="sendChat()">ÈÄÅ‰ø°</button>
                </div>
            </section>
        </div>
    </div>

    <div id="admin-panel">
        <input type="text" id="target-name" placeholder="„É¶„Éº„Ç∂„ÉºÂêç" style="width:100%; padding:5px; margin-bottom:5px;">
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px;">
            <button class="btn" onclick="quickTitle('ÁÆ°ÁêÜ‰∫∫')" style="background:gold; color:#000;">ÁÆ°ÁêÜ‰∫∫</button>
            <button class="btn" onclick="quickBan()" style="background:red;">IP BAN</button>
            <button class="btn" onclick="unBan()" style="background:green;">Ëß£Èô§</button>
            <button class="btn" onclick="renameAccount()" style="background:purple;">ÊîπÂêçÊîπÁ´Ñ</button>
            <button class="btn" onclick="quickTitle('')" style="background:#666;">Áß∞Âè∑Ââ•Â•™</button>
            <button class="btn" onclick="document.getElementById('admin-panel').style.display='none'">Èñâ„Åò„Çã</button>
        </div>
    </div>
    <div onclick="openAdminPanel()" style="position:fixed; bottom:0; right:0; width:40px; height:40px; opacity:0.1; z-index:9999;">‚öôÔ∏è</div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw", authDomain: "keshigomuuu-f5183.firebaseapp.com", projectId: "keshigomuuu-f5183", storageBucket: "keshigomuuu-f5183.firebasestorage.app", messagingSenderId: "541731028448", appId: "1:541731028448:web:512938a4ca14e61842bf85" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const ADMIN_PASS = "keshi99";
        
        let myIP = "", myName = localStorage.getItem("ntaro_user") || "", myTitle = "", myIcon = "", myBio = "";

        async function fetchIP() { try { const res = await fetch('https://api.ipify.org?format=json'); const data = await res.json(); myIP = data.ip; } catch(e) {} }

        window.onload = async () => {
            await fetchIP();
            if(myIP) {
                const ipDoc = await db.collection("ip_bans").doc(myIP.replace(/\./g, '_')).get();
                if(ipDoc.exists) { document.getElementById("main-content").style.display="none"; document.getElementById("ban-screen").style.display="flex"; return; }
            }
            if(myName) initUser(); else login();
            startSync();
        };

        async function initUser() {
            const d = await db.collection("users").doc(myName).get();
            if(d.exists) {
                const data = d.data();
                myTitle = data.title; myIcon = data.icon; myBio = data.bio;
                document.getElementById("display-user").innerText = myName;
                document.getElementById("my-top-icon").src = myIcon || "https://via.placeholder.com/50";
                document.getElementById("my-badge").innerHTML = myTitle ? `<span class="badge" style="background:black;border:1px solid gold;">${myTitle}</span>` : "";
                await db.collection("users").doc(myName).update({ last_ip: myIP || "unknown" });
            }
        }

        async function login() {
            let n = prompt("ÂêçÂâç"); if(!n) return;
            const r = db.collection("users").doc(n); const d = await r.get();
            if(d.exists) {
                if(prompt("„Éë„Çπ„ÉØ„Éº„Éâ") === d.data().pass) { myName = n; localStorage.setItem("ntaro_user", n); location.reload(); }
                else { alert("ÊãíÂê¶"); login(); }
            } else {
                let p = prompt("Êñ∞Ë¶è„Éë„Çπ„ÉØ„Éº„Éâ"); if(p) { await r.set({pass:p, title:"", icon:"", bio:"", last_ip: myIP || ""}); myName=n; localStorage.setItem("ntaro_user", n); location.reload(); }
            }
        }

        function startSync() {
            // „ÉÅ„É£„ÉÉ„ÉàÂêåÊúüÔºàÊîπÁ´Ñ„ÉªÂâäÈô§ÂØæÂøúÔºâ
            db.collection("chats").orderBy("date","desc").limit(20).onSnapshot(s => {
                document.getElementById("chat-display").innerHTML = s.docs.map(doc => {
                    const c = doc.data();
                    return `<div class="chat-bubble" oncontextmenu="adminEdit('${doc.id}','chats','${c.msg}');return false;" ontouchstart="handleLongPress(()=>adminEdit('${doc.id}','chats','${c.msg}'))">
                        <img src="${c.icon || 'https://via.placeholder.com/50'}" class="chat-icon">
                        <div style="flex:1"><div class="chat-name">${c.name}</div><div style="font-size:0.8em;">${c.msg}</div></div>
                    </div>`;
                }).reverse().join('');
                document.getElementById("chat-display").scrollTop = 999;
            });
            // „É≠„Ç∞ÂêåÊúü
            db.collection("logs").orderBy("date","desc").limit(10).onSnapshot(s => {
                document.getElementById("log-display").innerHTML = s.docs.map(doc => `<div>„Éª${doc.data().text}</div>`).join('');
            });
            // „É©„É≥„Ç≠„É≥„Ç∞ÂêåÊúü
            db.collection("ranking").orderBy("score","desc").limit(10).onSnapshot(s => {
                document.getElementById("ranking-display").innerHTML = s.docs.map((doc, i) => `
                <div class="list-item" oncontextmenu="adminEdit('${doc.id}','ranking');return false;" ontouchstart="handleLongPress(()=>adminEdit('${doc.id}','ranking'))">
                    <span>${i+1}. ${doc.data().name}</span><b>${doc.data().score}</b>
                </div>`).join('');
            });
        }

        async function adminEdit(id, col, oldVal) {
            if(prompt("ÁÆ°ÁêÜËÄÖ„Éë„Çπ") !== ADMIN_PASS) return;
            let act = prompt("1:ÂâäÈô§ 2:ÊîπÁ´Ñ(Á∑®ÈõÜ)");
            if(act === "1") await db.collection(col).doc(id).delete();
            if(act === "2" && col === "chats") {
                let newVal = prompt("ÂÜÖÂÆπ„ÇíÊõ∏„ÅçÊèõ„Åà", oldVal);
                if(newVal) await db.collection(col).doc(id).update({msg: newVal});
            }
        }

        async function renameAccount() {
            const oldN = document.getElementById("target-name").value;
            const newN = prompt("Êñ∞„Åó„ÅÑÂêçÂâç„Å´ÊîπÁ´Ñ");
            const newP = prompt("Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ„Å´ÊîπÁ´Ñ");
            if(oldN && newN) {
                const d = await db.collection("users").doc(oldN).get();
                if(d.exists) {
                    let data = d.data();
                    if(newP) data.pass = newP;
                    await db.collection("users").doc(newN).set(data);
                    await db.collection("users").doc(oldN).delete();
                    alert("ÂêçÂâç„Å®ÊÉÖÂ†±„ÇíÊîπÁ´Ñ„Åó„Åæ„Åó„Åü");
                }
            }
        }

        async function saveProfile() {
            await db.collection("users").doc(myName).update({ icon: document.getElementById("set-icon").value, bio: document.getElementById("set-bio").value });
            alert("‰øùÂ≠òÂÆå‰∫Ü"); location.reload();
        }

        async function sendChat() {
            const m = document.getElementById("chat-msg").value;
            if(m && myName) { 
                await db.collection("chats").add({ name: myName, msg: m, icon: myIcon, date: new Date() });
                await db.collection("logs").add({ text: `${myName}„ÅåÁô∫Ë®Ä`, date: new Date() });
                document.getElementById("chat-msg").value=""; 
            }
        }

        function openAdminPanel() { if(prompt("ÁÆ°ÁêÜËÄÖ„Éë„Çπ") === ADMIN_PASS) document.getElementById("admin-panel").style.display="block"; }
        async function quickTitle(t) { const n = document.getElementById("target-name").value; if(n) await db.collection("users").doc(n).update({title: t}); }
        async function quickBan() {
            const n = document.getElementById("target-name").value;
            const u = await db.collection("users").doc(n).get();
            if(u.exists && u.data().last_ip) await db.collection("ip_bans").doc(u.data().last_ip.replace(/\./g, '_')).set({name: n});
        }
        async function unBan() {
            const n = document.getElementById("target-name").value;
            const u = await db.collection("users").doc(n).get();
            if(u.exists && u.data().last_ip) await db.collection("ip_bans").doc(u.data().last_ip.replace(/\./g, '_')).delete();
        }

        // --- GAME ---
        let score = 0, gameActive = false, timeLeft = 45;
        function startGame() {
            score = 0; timeLeft = 45; gameActive = true;
            document.getElementById("start-screen").style.display="none";
            const ti = setInterval(() => {
                timeLeft--; document.getElementById("timer").innerText = "TIME: " + timeLeft;
                if(timeLeft <= 0 || !gameActive) { 
                    clearInterval(ti); gameActive = false; 
                    db.collection("ranking").add({name: myName, score, date: new Date()});
                    db.collection("logs").add({text: `${myName}„Åå${score}ÁÇπÁç≤Âæó`, date: new Date()});
                    document.getElementById("start-screen").style.display="flex";
                }
            }, 1000);
            spawn();
        }
        function spawn() {
            if(!gameActive) return;
            const it = document.createElement("div"); it.className="kusu"; it.innerText = Math.random() < 0.2 ? "üí£" : "‚≠ê";
            it.style.left = Math.random() * (document.getElementById("game-container").offsetWidth - 30) + "px"; it.style.top = "-30px";
            document.getElementById("game-container").appendChild(it);
            let fall = setInterval(() => {
                let t = parseInt(it.style.top); it.style.top = (t + 6) + "px";
                const pR = document.getElementById("player").getBoundingClientRect(), iR = it.getBoundingClientRect();
                if (!(pR.top > iR.bottom || pR.bottom < iR.top || pR.left > iR.right || pR.right < iR.left)) {
                    score += (it.innerText === "üí£" ? -50 : 10); document.getElementById("score-board").innerText = "SCORE: " + score;
                    it.remove(); clearInterval(fall);
                }
                if(t > 320) { it.remove(); clearInterval(fall); }
            }, 20);
            setTimeout(spawn, myTitle === 'ÁÆ°ÁêÜ‰∫∫' ? 250 : 600);
        }
        function move(cx) {
            if(!gameActive) return;
            const r = document.getElementById("game-container").getBoundingClientRect();
            document.getElementById("player").style.left = (cx - r.left - 30) + "px";
        }
        document.getElementById("game-container").addEventListener("mousemove", e => move(e.clientX));
        document.getElementById("game-container").addEventListener("touchmove", e => { e.preventDefault(); move(e.touches[0].clientX); }, {passive:false});
        
        let pressTimer; function handleLongPress(f) { pressTimer = setTimeout(f, 800); }
        window.onmouseup = window.ontouchend = () => clearTimeout(pressTimer);
    </script>
</body>
</html>
