<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† å…¬å¼ã‚µã‚¤ãƒˆ</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-blue: #4A90E2; --bg-color: #f0f4f8; --text-color: #333; --sub-blue: #EAF4FF; --fever-gold: #FFD700; }
        body { font-family: "Hiragino Maru Gothic Pro", "Yu Gothic", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); text-align: center; }
        header { background: linear-gradient(135deg, #fff, var(--sub-blue)); padding: 20px; border-bottom: 5px solid var(--main-blue); }
        .account-bar { background: var(--main-blue); color: #fff; padding: 5px; font-size: 0.8em; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; background: #fff; }
        section { margin-bottom: 25px; padding: 20px; border-radius: 20px; background: #fff; border: 2px solid var(--sub-blue); }
        .hero { background-color: var(--sub-blue); border: none; }
        .char-img { max-width: 140px; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.1)); cursor: pointer; }
        .profile-text { text-align: left; background: #fff; padding: 12px; border-radius: 10px; font-size: 0.85em; margin-top: 10px; border-left: 5px solid var(--main-blue); }
        #game-container { position: relative; width: 100%; height: 400px; background-color: var(--sub-blue); border-radius: 10px; overflow: hidden; touch-action: none; cursor: none; }
        #player { position: absolute; bottom: 10px; width: 60px; z-index: 10; pointer-events: none; transition: width 0.3s; }
        .badge { font-size: 0.7em; padding: 2px 6px; border-radius: 4px; margin-right: 4px; color: white; font-weight: bold; }
        .badge-craftsman { background: #50c878; } /* è·äºº:ç·‘ */
        .badge-master { background: #ff4500; }    /* ãƒã‚¹ã‚¿ãƒ¼:æœ± */
        .badge-admin { background: #000000; color: #ffd700; border: 1px solid #ffd700; } /* ç®¡ç†äºº:é»’é‡‘ */
        .list-box { text-align: left; background: #fff; border-radius: 10px; padding: 10px; min-height: 80px; max-height: 200px; overflow-y: auto; }
        .list-item { padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 0.85em; display: flex; justify-content: space-between; cursor: pointer; }
        .chat-container { text-align: left; height: 300px; overflow-y: auto; padding: 15px; background: var(--sub-blue); border-radius: 15px; display: flex; flex-direction: column; }
        .chat-bubble { background: #fff; border-radius: 15px; padding: 8px 12px; margin-bottom: 8px; align-self: flex-start; max-width: 85%; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        .chat-name { font-size: 0.7em; color: var(--main-blue); font-weight: bold; }
        .btn { padding: 10px 20px; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; background: var(--main-blue); color: #fff; }
        #ban-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; color: white; z-index: 10000; justify-content: center; align-items: center; }
    </style>
</head>
<body>
    <div id="ban-screen"><h1>ğŸš« è¿½æ”¾ã•ã‚Œã¾ã—ãŸ</h1></div>
    <div id="main-content">
        <div class="account-bar">ğŸ‘¤ <span id="display-user">ã‚²ã‚¹ãƒˆ</span> <span id="my-badge"></span></div>
        <header><h1>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã† å…¬å¼</h1></header>
        <div class="container">
            <section class="hero">
                <img src="image_b322c7.png" class="char-img">
                <div class="profile-text"><strong>æ¶ˆã—ã‚´ãƒ ã‚“ãŸã‚ã†</strong>ï¼šé–“é•ã„ã‚’æ¶ˆã—å»ã‚‹å­¤é«˜ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ã€‚</div>
            </section>
            <section id="game-section">
                <div id="game-container"><img src="image_b322c7.png" id="player">
                    <div id="start-screen" style="position:absolute; width:100%; height:100%; background:rgba(74, 144, 226, 0.8); display:flex; align-items:center; justify-content:center; z-index:100;">
                        <button class="btn" onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                    </div>
                </div>
                <p id="score-board">ã‚¹ã‚³ã‚¢: 0</p>
            </section>
            <section style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><h4>ğŸš€ ãƒ­ã‚°</h4><div class="list-box" id="log-display"></div></div>
                <div><h4 oncontextmenu="resetRankingExceptTop();return false;" onclick="handleLongPress(resetRankingExceptTop)">ğŸ† é †ä½</h4><div class="list-box" id="ranking-display"></div></div>
            </section>
            <section>
                <div class="chat-container" id="chat-display"></div>
                <div class="chat-input-area"><input type="text" id="chat-msg" placeholder="æ›¸ã‘..."><button class="btn" onclick="sendChat()">é€ä¿¡</button></div>
            </section>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBjhqORK7LsHZZWw_aDnVPSA_IstYqBLRw", authDomain: "keshigomuuu-f5183.firebaseapp.com", projectId: "keshigomuuu-f5183", storageBucket: "keshigomuuu-f5183.firebasestorage.app", messagingSenderId: "541731028448", appId: "1:541731028448:web:512938a4ca14e61842bf85" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const ADMIN_PASS = "keshi99";
        let myID = localStorage.getItem("ntaro_id") || "ID_" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("ntaro_id", myID);
        let myName = localStorage.getItem("ntaro_user") || "";
        let myTitle = "";

        window.onload = () => { startLoadingData(); setTimeout(initAccount, 800); };

        function getBadgeHTML(title) {
            if(!title) return "";
            const cls = title==='ç®¡ç†äºº'?'badge-admin':(title==='æ¶ˆã—ã‚´ãƒ ãƒã‚¹ã‚¿ãƒ¼'?'badge-master':'badge-craftsman');
            return `<span class="badge ${cls}">${title}</span>`;
        }

        function startLoadingData() {
            db.collection("chats").orderBy("date", "asc").limitToLast(15).onSnapshot(snap => {
                document.getElementById('chat-display').innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="chat-bubble" oncontextmenu="openAdminMenu('${d.uid}','${d.name}','chats','${doc.id}','${d.msg}');return false;" onclick="handleLongPress(()=>openAdminMenu('${d.uid}','${d.name}','chats','${doc.id}','${d.msg}'))">
                        <div class="chat-name">${getBadgeHTML(d.title)}${d.name}</div><div>${d.msg}</div>
                    </div>`;
                }).join('');
                document.getElementById('chat-display').scrollTop = 9999;
            });
            db.collection("ranking").orderBy("score", "desc").limit(5).onSnapshot(snap => {
                document.getElementById('ranking-display').innerHTML = snap.docs.map((doc, i) => {
                    const d = doc.data();
                    return `<div class="list-item" onclick="handleLongPress(()=>openAdminMenu('${d.uid}','${d.name}','ranking','${doc.id}',${d.score}))">
                        <span>${i+1}ä½:${getBadgeHTML(d.title)}${d.name}</span><span>${d.score}</span>
                    </div>`;
                }).join('');
            });
        }

        async function openAdminMenu(tid, tname, col, docId, currentVal) {
            if(prompt("ç®¡ç†è€…ãƒ‘ã‚¹") !== ADMIN_PASS) return;
            let action = prompt("1:å‰Šé™¤ 2:BAN 3:æ”¹ã–ã‚“ 4:åå‰æ”¹ã–ã‚“ 5:ç§°å·ä»˜ä¸");
            if(action === "1") await db.collection(col).doc(docId).delete();
            else if(action === "2") await db.collection("bans").doc(tid).set({until: firebase.firestore.Timestamp.fromDate(new Date("9999-12-31")), name: tname});
            else if(action === "3") {
                let v = prompt("å€¤", currentVal);
                if(v) await db.collection(col).doc(docId).update(col==='chats'?{msg:v}:{score:parseInt(v)});
            }
            else if(action === "4") {
                let n = prompt("åå‰æ”¹ã–ã‚“", tname);
                if(n) await db.collection(col).doc(docId).update({name: n});
            }
            else if(action === "5") {
                let t = prompt("ç§°å·ã‚’é¸æŠã—ã¦ãã ã•ã„\n1:ãªã— 2:æ¶ˆã—ã‚´ãƒ è·äºº 3:æ¶ˆã—ã‚´ãƒ ãƒã‚¹ã‚¿ãƒ¼ 4:ç®¡ç†äºº");
                let title = "";
                if(t==="2") title="æ¶ˆã—ã‚´ãƒ è·äºº"; else if(t==="3") title="æ¶ˆã—ã‚´ãƒ ãƒã‚¹ã‚¿ãƒ¼"; else if(t==="4") title="ç®¡ç†äºº";
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨ç¾åœ¨ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸¡æ–¹ã‚’æ›´æ–°
                await db.collection("users").where("uid","==",tid).get().then(s => s.forEach(d => d.ref.update({title: title})));
                await db.collection(col).doc(docId).update({title: title});
                alert("ç§°å·ã‚’æˆã‘ã¾ã—ãŸ");
            }
        }

        async function initAccount() {
            const ban = await db.collection("bans").doc(myID).get();
            if(ban.exists) { document.getElementById("main-content").style.display = "none"; document.getElementById("ban-screen").style.display = "flex"; return; }
            if (!myName) { await loginFlow(); } else {
                const userDoc = await db.collection("users").doc(myName).get();
                if(userDoc.exists) {
                    myTitle = userDoc.data().title || "";
                    document.getElementById("my-badge").innerHTML = getBadgeHTML(myTitle);
                }
                document.getElementById("display-user").innerText = myName;
            }
        }

        async function loginFlow() {
            let n = prompt("åå‰"); if(!n) return;
            const ref = db.collection("users").doc(n); const d = await ref.get();
            if(d.exists) { if(prompt("ãƒ‘ã‚¹")===d.data().pass) { myName=n; myTitle=d.data().title||""; } else return loginFlow(); }
            else { let p=prompt("ãƒ‘ã‚¹è¨­å®š"); if(p){ await ref.set({pass:p, uid:myID, title:""}); myName=n; } }
            localStorage.setItem("ntaro_user", myName); document.getElementById("display-user").innerText = myName;
            document.getElementById("my-badge").innerHTML = getBadgeHTML(myTitle);
        }

        // --- ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆãƒãƒ•é©ç”¨ï¼‰ ---
        let score = 0, gameActive = false;
        function startGame() {
            if(!myName) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");
            score=0; gameActive=true; document.getElementById('start-screen').style.display='none';
            if(myTitle==='ç®¡ç†äºº') document.getElementById('player').style.width = "150px";
            spawnItem();
            setTimeout(()=>{ gameActive=false; alert("çµ‚äº†ï¼æœ€çµ‚ã‚¹ã‚³ã‚¢: "+score); saveScoreToFirebase(); document.getElementById('start-screen').style.display='flex'; document.getElementById('player').style.width = "60px"; }, 30000);
        }
        function spawnItem() {
            if(!gameActive) return;
            const it = document.createElement('div'); it.className='kusu'; it.innerText='â­';
            it.style.left=Math.random()*(document.getElementById('game-container').offsetWidth-30)+'px'; it.style.top='0px';
            document.getElementById('game-container').appendChild(it);
            let fall = setInterval(() => {
                let top = parseInt(it.style.top); it.style.top = (top + 5) + 'px';
                const pR = document.getElementById('player').getBoundingClientRect(), iR = it.getBoundingClientRect();
                if (!(pR.top > iR.bottom || pR.bottom < iR.top || pR.left > iR.right || pR.right < iR.left)) {
                    let base = 10;
                    if(myTitle==='æ¶ˆã—ã‚´ãƒ è·äºº') base *= 1.2;
                    else if(myTitle==='æ¶ˆã—ã‚´ãƒ ãƒã‚¹ã‚¿ãƒ¼') base *= 1.5;
                    else if(myTitle==='ç®¡ç†äºº') base *= 3.0;
                    score += Math.round(base); document.getElementById('score-board').innerText = "ã‚¹ã‚³ã‚¢: "+score;
                    it.remove(); clearInterval(fall);
                }
                if (top > 400) { it.remove(); clearInterval(fall); }
            }, 20);
            setTimeout(spawnItem, myTitle==='ç®¡ç†äºº'?150:500);
        }
        async function saveScoreToFirebase() { await db.collection("ranking").add({uid:myID, name:myName, score, title:myTitle, date: firebase.firestore.FieldValue.serverTimestamp()}); }
        async function sendChat() { const m = document.getElementById('chat-msg').value; if(m&&myName) await db.collection("chats").add({uid:myID, name:myName, msg:m, title:myTitle, date: firebase.firestore.FieldValue.serverTimestamp()}); document.getElementById('chat-msg').value=""; }
        async function resetRankingExceptTop() { if(prompt("ãƒ‘ã‚¹")!==ADMIN_PASS) return; const s = await db.collection("ranking").orderBy("score","desc").get(); const b = db.batch(); s.docs.slice(1).forEach(d => b.delete(d.ref)); await b.commit(); }
        let pt; function handleLongPress(f){ pt=setTimeout(f,800); }
        window.onmouseup=()=>clearTimeout(pt); window.ontouchend=()=>clearTimeout(pt);
        function move(cx) { if(!gameActive) return; const rect = document.getElementById('game-container').getBoundingClientRect(); let x = cx - rect.left - (document.getElementById('player').offsetWidth/2); document.getElementById('player').style.left = x + 'px'; }
        document.getElementById('game-container').addEventListener('mousemove', (e)=>move(e.clientX));
        document.getElementById('game-container').addEventListener('touchmove', (e)=>{ e.preventDefault(); move(e.touches[0].clientX); }, {passive:false});
    </script>
</body>
</html>
